/* Twitch Filtered Chat Main Module */"use strict";/* FIXME:
 * HTML injection via Content.addHelpLine
 * Username context window should slide rather than teleport to new names
 * Chat line backgrounds flicker between messages
 *   Caused by non-chat messagesclearing excess chat messages
 * Browser autofills prevent disabling authentication
 *//* TODO (in approximate decreasing priority):
 * Add to content to both #settings help and builder links
 *   Change AssetPaths.BUILDER_WINDOW to use the new builder
 *   shayd3 is working on the builder
 * Move authentication to using Twitch's implicit OAuth flow?
 * Create a README.md file for the plugins directory. Include documentation on:
 *   Commands
 *   Filtering
 *   Plugin configuration (?plugincfg)
 * Add configurable message highlighting (//highlight)
 * Auto-complete command arguments
 * Remove F1 hotkey binding
 *//* IDEAS:
 * Add layout selection box to #settings (reloads page on change)?
 * Allow for a configurable number of columns?
 * Add re-include (post-exclude) filtering options for Mods, Bits, Subs, etc?
 *//* Utility functions {{{0 *//* Call func when the input element is changed */var _slicedToArray=function(){function e(e,t){var a=[],n=!0,r=!1,d=void 0;try{for(var i,l=e[Symbol.iterator]();!(n=(i=l.next()).done)&&(a.push(i.value),!(t&&a.length===t));n=!0);}catch(e){r=!0,d=e}finally{try{!n&&l["return"]&&l["return"]()}finally{if(r)throw d}}return a}return function(t,a){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return e(t,a);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},_createClass=function(){function e(e,t){for(var a,n=0;n<t.length;n++)a=t[n],a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}return function(t,a,n){return a&&e(t.prototype,a),n&&e(t,n),t}}();function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function onChange(t,a){var n=!0,r=!1,d=void 0;try{for(var i,l=$(t)[Symbol.iterator]();!(n=(i=l.next()).done);n=!0){var o=i.value,e=$(o);if(e.is("input")){var s=e.attr("type");"text"===s?(e.keyup(function(e){if("Enter"===e.key)return a.bind(this)(e)}),e.blur(function(e){a.bind(this)(e)})):"checkbox"===s?e.change(function(e){a.bind(this)(e)}):e.change(function(e){a.bind(this)(e)})}else e.change(function(e){a.bind(this)(e)})}}catch(e){r=!0,d=e}finally{try{!n&&l.return&&l.return()}finally{if(r)throw d}}}/* End utility functions 0}}} *//* Document writing functions {{{0 */var Content=function(){function t(){_classCallCheck(this,t)}return _createClass(t,null,[{key:"add",/* exported Content *//* Add text: escapes */value:function a(e){t.addHTML($("<span class=\"message\"></span>").text(e))}/* Add HTML: does not escape */},{key:"addHTML",value:function d(e){var t=Math.pow,a=1<arguments.length&&void 0!==arguments[1]?arguments[1]:null,n=a?$(a):$(".module .content"),r=$("<div class=\"line line-wrapper\"></div>");"string"==typeof e?r.html(e):e instanceof Node?r.append($(e)):r.append(e),n.append(r),n.attr("data-no-scroll")||n.scrollTop(t(2,31)-1)}/* Add "pre" content: does not escape */},{key:"addPre",value:function a(e){t.addHTML($("<div class=\"pre\"></div>").html(e))}/* Add "pre" text: escapes */},{key:"addPreText",value:function a(e){t.addHTML($("<div class=\"pre\"></div>").text(e))}/* Add info content: does not escape */},{key:"addInfo",value:function e(a){var n=!!(1<arguments.length&&void 0!==arguments[1])&&arguments[1],r=$("<div class=\"info\"></div>").html(a);n&&r.addClass("pre"),t.addHTML(r)}/* Add info text: escapes */},{key:"addInfoText",value:function e(a){var n=!!(1<arguments.length&&void 0!==arguments[1])&&arguments[1],r=$("<div class=\"info\"></div>").text(a);n&&r.addClass("pre"),t.addHTML(r)}/* Add notice (warning) content: does not escape */},{key:"addNotice",value:function e(a){var n=!!(1<arguments.length&&void 0!==arguments[1])&&arguments[1],r=$("<div class=\"notice\"></div>").html(a);n&&r.addClass("pre"),t.addHTML(r)}/* Add notice (warning) text: escapes */},{key:"addNoticeText",value:function e(a){var n=!!(1<arguments.length&&void 0!==arguments[1])&&arguments[1],r=$("<div class=\"notice\"></div>").text(a);n&&r.addClass("pre"),t.addHTML(r)}/* Add error content: does not escape */},{key:"addError",value:function e(a){var n=!!(1<arguments.length&&void 0!==arguments[1])&&arguments[1],r=$("<div class=\"error\"></div>").html(a);n&&r.addClass("pre"),t.addHTML(r)}/* Add error text: escapes */},{key:"addErrorText",value:function e(a){var n=!!(1<arguments.length&&void 0!==arguments[1])&&arguments[1],r=$("<div class=\"error\"></div>").text(a);n&&r.addClass("pre"),t.addHTML(r)}/* Add help content: does not escape */},{key:"addHelp",value:function a(e){t.addPre($("<div class=\"help\"></div>").html(e))}/* Add help text: escapes */},{key:"addHelpText",value:function a(e){t.addPre($("<div class=\"help\"></div>").text(e))}/* Add help line pair: does not escape */},{key:"addHelpLine",value:function n(e,a){t.addHelp(ChatCommands.helpLine(e,a))}}]),t}();/* End document writing functions 0}}} *//* Begin configuration section {{{0 *//* Merge the query string into the config object given and return removals */function parseQueryString(e){var t=Math.clamp,a=1<arguments.length&&void 0!==arguments[1]?arguments[1]:null,n={},r=[],d=a||window.location.search;/* Figure out what was passed *//* Generated configuration *//* List of keys to remove from window.location */"string"==typeof d?n=Util.ParseQueryString(d):"object"===("undefined"==typeof d?"undefined":_typeof(d))?n=d:Util.Error("Refusing to parse strange query string object",d);var i=!0,l=!1,o=void 0;try{for(var s,c=Object.entries(n)[Symbol.iterator]();!(i=(s=c.next()).done);i=!0){var u=s.value,g=_slicedToArray(u,2),p=g[0],h=g[1],f=p,m=h;/* config key *//* config val */if("clientid"===p)f="ClientID",e.__clientid_override=!0,r.push(p);else if("user"===p||"name"===p||"nick"===p)f="Name";else if("pass"===p||"oauth"===p)f="Pass",r.push(p);else if("channel"===p||"channels"===p)f="Channels",m=h.split(",").map(function(e){return Twitch.FormatChannel(e)});else if("debug"===p)f="Debug",m="boolean"==typeof h?h:"number"==typeof h?t(h,Util.LEVEL_MIN,Util.LEVEL_MAX):"debug"===h?Util.LEVEL_DEBUG:"trace"===h?Util.LEVEL_TRACE:!!h;else if("noassets"===p)f="NoAssets",m=!!h;else if("noffz"===p)f="NoFFZ",m=!!h;else if("nobttv"===p)f="NoBTTV",m=!!h;else if("hmax"===p)f="HistorySize","inf"===h?m=1/0:"number"==typeof h?m=h:(Util.WarnOnly("Invalid hmax value "+h+"; defaulting"),m=TwitchClient.DEFAULT_HISTORY_SIZE);else if(p.match(/^module[\d]*?$/))f="module"===p?"module1":p,m=parseModuleConfig(h);else if("trans"===p||"transparent"===p)f="Transparent",m=1;else if("layout"===p)f="Layout",m=ParseLayout(h);else if("norec"===p)f="NoAutoReconnect",m=!0;else if("size"===p)f="Size",m=h+"pt";else if("plugins"===p)f="Plugins",m=!!h;else if("disable"===p)f="DisableEffects",m=h.split(",");else if("enable"===p)f="EnableEffects",m=h.split(",");else if("max"===p)f="MaxMessages","inf"===h||-1===h?m=1/0:"number"==typeof h?m=h:(Util.WarnOnly("Invalid max value "+h+"; defaulting"),m=TwitchClient.DEFAULT_MAX_MESSAGES);else if("font"===p)f="Font",m=""+h;else if("scroll"===p)f="Scroll",m=!!h;else if("clips"===p)f="ShowClips",m=!!h;else if("plugincfg"===p){f="PluginConfig";try{m=JSON.parse(h)}catch(t){Util.Error(t),f=m=null}}else if("scheme"===p)f="ColorScheme","light"===h?m="light":"dark"===h?m="dark":(Util.WarnOnly("Invalid scheme value "+h+", defaulting to dark"),m="dark");else if("force"===p||"antics"===p)f="EnableForce",m=!!h;else if("fanfare"===p){f="Fanfare",m={enable:!1};try{var b=JSON.parse(h);"number"==typeof b?m.enable=0!==b:"boolean"==typeof b?m.enable=b:"object"===("undefined"==typeof b?"undefined":_typeof(b))?(m=b,m.enable=!0):(Util.Error("Don't know how to parse Fanfare value",b),f=m=null)}catch(t){Util.Error("Failed parsing Fanfare config; disabling",t,h),f=m=null}}else"highlight"===p&&(f="Highlight",m=(""+h).split(",").map(function(e){return Util.StringToRegExp(e,"g")}));/* Skip items with a falsy key */f&&(e[f]=m)}}catch(e){l=!0,o=e}finally{try{!i&&c.return&&c.return()}finally{if(l)throw o}}return r}/* Obtain configuration key */function getConfigKey(){var e=CFG_KEY,t=Util.ParseQueryString(),a=t.config_key||t.key||t["config-key"];return a&&(e=e+"-"+a.replace(/[^a-z]/g,"")),e}/* Obtain configuration */function getConfigObject(){var t=!!(0<arguments.length&&void 0!==arguments[0])&&arguments[0],a=null,n=null,r=Util.ParseQueryString();/* 1) Obtain configuration values
   *  a) from localStorage
   *  b) from query string (overrides (a))
   *  c) from settings elements (overrides (b))
   *  d) from liveStorage (module settings only, overrides (c))
   * 2) Store module configuration in each modules' settings window
   * 3) Remove sensitive values from the query string, if present
   *//* Query String object, parsed *//* Obtain configuration from local storage */if(r.nols)Util.DisableLocalStorage(),n={};else{a=getConfigKey(),Util.SetWebStorageKey(a),a!==CFG_KEY&&Util.LogOnlyOnce("Using custom config key \""+Util.GetWebStorageKey()+"\""),n=Util.GetWebStorage()||{},n.key=a;/* Purge obsolete configuration items */var d=["AutoReconnect","NoForce"],i=!1,l=!0,o=!1,s=void 0;try{for(var c,u,g=d[Symbol.iterator]();!(l=(c=g.next()).done);l=!0)u=c.value,n.hasOwnProperty(u)&&(i=!0,delete n[u])}catch(e){o=!0,s=e}finally{try{!l&&g.return&&g.return()}finally{if(o)throw s}}i&&Util.SetWebStorage(n)}/* Certain unwanted items may be preserved in localStorage */var p=["NoAssets","Debug","NoAutoReconnect","Layout","Transparent","Plugins","EnableEffects","DisableEffects","PluginConfig","ColorScheme","nols","EnableForce"],h=!0,f=!1,m=void 0;try{for(var b,v,S=p[Symbol.iterator]();!(h=(b=S.next()).done);h=!0)v=b.value,n.hasOwnProperty(v)&&delete n[v];/* Parse the query string, storing items to remove */}catch(e){f=!0,m=e}finally{try{!h&&S.return&&S.return()}finally{if(f)throw m}}var y=parseQueryString(n,r);/* Ensure config.Channels is present for #settings configuration below */Util.IsArray(n.Channels)||(n.Channels=[]);/* Obtain global settings config */var x=$("input#txtChannel"),C=$("input#txtNick"),L=$("input#txtPass");if(x.val()){var E=!0,k=!1,T=void 0;try{for(var w,H=x.val().split(",")[Symbol.iterator]();!(E=(w=H.next()).done);E=!0){var I=w.value,P=Twitch.FormatChannel(I.toLowerCase());-1===n.Channels.indexOf(P)&&n.Channels.push(P)}}catch(e){k=!0,T=e}finally{try{!E&&H.return&&H.return()}finally{if(k)throw T}}}/* See if there's any sensitive information we need to remove */if(C.val()&&C.val()!==Strings.NAME_AUTOGEN&&(n.Name=C.val()),t&&L.val()&&L.val()!==Strings.PASS_CACHED&&(n.Pass=L.val()),n.hasOwnProperty("Scroll")||(n.Scroll=$("#cbScroll").is(":checked")),n.hasOwnProperty("ShowClips")||(n.ShowClips=$("#cbClips").is(":checked")),n.hasOwnProperty("EnableForce")||(n.EnableForce=$("#cbForce").is(":checked")),$(".module").each(function(){var e=$(this).attr("id"),t=function(e){return Util.IsArray(e)?e:[]};/* Populate module configuration from liveStorage (if present) */if(n[e]||(n[e]=getModuleSettings($(this))),window.liveStorage&&window.liveStorage[e]){var a=!0,r=!1,d=void 0;try{for(var i,l=Object.entries(window.liveStorage[e])[Symbol.iterator]();!(a=(i=l.next()).done);a=!0){var o=i.value,s=_slicedToArray(o,2),c=s[0],u=s[1];n[e][c]=u}}catch(e){r=!0,d=e}finally{try{!a&&l.return&&l.return()}finally{if(r)throw d}}}/* Ensure all the settings have the proper types */n[e].Pleb=!!n[e].Pleb,n[e].Sub=!!n[e].Sub,n[e].VIP=!!n[e].VIP,n[e].Mod=!!n[e].Mod,n[e].Event=!!n[e].Event,n[e].Bits=!!n[e].Bits,n[e].Me=!!n[e].Me,n[e].IncludeKeyword=t(n[e].IncludeKeyword),n[e].IncludeUser=t(n[e].IncludeUser),n[e].ExcludeUser=t(n[e].ExcludeUser),n[e].ExcludeStartsWith=t(n[e].ExcludeStartsWith),n[e].FromChannel=t(n[e].FromChannel)}),0<y.length){Util.SetWebStorage(n);/* Obtain the current query string */var M=Util.ParseQueryString(window.location.search.substr(1)),A=!1;M.base64&&0<M.base64.length&&(A=!0,M=Util.ParseQueryString(atob(M.base64)));/* Remove the sensitive items */var N=!0,_=!1,F=void 0;try{for(var D,O,G=y[Symbol.iterator]();!(N=(D=G.next()).done);N=!0)O=D.value,delete M[O];/* Create and apply a new query string */}catch(e){_=!0,F=e}finally{try{!N&&G.return&&G.return()}finally{if(_)throw F}}var B=Util.FormatQueryString(M);A&&(B="?base64="+encodeURIComponent(btoa(B))),window.location.search=B}/* Merge in top-level liveStorage items */if(window.liveStorage){var U=!0,R=!1,W=void 0;try{for(var j,V,z=Object.keys(window.liveStorage)[Symbol.iterator]();!(U=(j=z.next()).done);U=!0)V=j.value,V.match(/^module[0-9]*$/)||n[V]===window.liveStorage[V]||(n[V]=window.liveStorage[V])}catch(e){R=!0,W=e}finally{try{!U&&z.return&&z.return()}finally{if(R)throw W}}}/* Finally, ensure certain defaults *//* Default name is no name */return"string"!=typeof n.Name&&(n.Name=""),n.hasOwnProperty("Plugins")||(n.Plugins=!1),n.hasOwnProperty("Debug")||(n.Debug=!1),n.hasOwnProperty("Channels")||(n.Channels=[]),n.hasOwnProperty("Layout")||(n.Layout=GetLayout()),n.hasOwnProperty("MaxMessages")||(n.MaxMessages=TwitchClient.DEFAULT_MAX_MESSAGES),n.hasOwnProperty("HistorySize")||(n.HistorySize=TwitchClient.DEFAULT_HISTORY_SIZE),t?!n.ClientID&&(n.ClientID=[19,86,67,115,22,38,198,3,55,118,67,35,150,230,71,134,83,3,119,166,86,39,38,167,135,134,147,214,38,55].map(function(e){return Util.ASCII[16*(15&e)+(240&e)/16]}).join("")):(n.ClientID=null,delete n.ClientID,delete n.Pass),n}/* Obtain singular configuration */function getConfigValue(e){return getConfigObject()[e]}/* Store configuration */function mergeConfigObject(){var e=0<arguments.length&&arguments[0]!==void 0?arguments[0]:null,t=e||{},a=getConfigObject(!0);if(Util.IsArray(t)){var n=!0,r=!1,d=void 0;try{for(var i,l=t[Symbol.iterator]();!(n=(i=l.next()).done);n=!0){var o=i.value,s=_slicedToArray(o,2),c=s[0],u=s[1];a[c]=u}}catch(e){r=!0,d=e}finally{try{!n&&l.return&&l.return()}finally{if(r)throw d}}}else{var g=!0,p=!1,h=void 0;try{for(var f,m=Object.entries(t)[Symbol.iterator]();!(g=(f=m.next()).done);g=!0){var b=f.value,v=_slicedToArray(b,2),S=v[0],y=v[1];a[S]=y}}catch(e){p=!0,h=e}finally{try{!g&&m.return&&m.return()}finally{if(p)throw h}}}Util.SetWebStorage(a),window.liveStorage=a}/* Module configuration {{{1 *//* Enumerate the active modules */function getModules(){/* exported getModules */var e={},t=!0,a=!1,n=void 0;try{for(var r,d,i=$(".module")[Symbol.iterator]();!(t=(r=i.next()).done);t=!0)d=r.value,e[$(d).attr("id")]=d}catch(e){a=!0,n=e}finally{try{!t&&i.return&&i.return()}finally{if(a)throw n}}return e}/* Apply configuration to the module's settings HTML */function setModuleSettings(e,t){function a(e,t,a){if(a&&0<a.length){var r=!0,d=!1,i=void 0;try{for(var l,o=a[Symbol.iterator]();!(r=(l=o.next()).done);r=!0){var s=l.value,c=$("<li></li>"),u="input."+CSS.escape(e)+"[value=\""+CSS.escape(s)+"\"]";if(0===n.find(u).length){var g=$("<label></label>").val(t),p=$("<input type=\"checkbox\" checked />");p.addClass(e),p.attr("value",s),p.click(updateModuleConfig),g.append(p),g.html(g.html()+t+s.escape()),c.append(g),n.find("li."+CSS.escape(e)).before(c)}}}catch(e){d=!0,i=e}finally{try{!r&&o.return&&o.return()}finally{if(d)throw i}}}}var n=$(e);t.Name&&(n.find("label.name").html(t.Name),n.find("input.name").val(t.Name)),n.find("input.pleb").check(t.Pleb),n.find("input.sub").check(t.Sub),n.find("input.vip").check(t.VIP),n.find("input.mod").check(t.Mod),n.find("input.event").check(t.Event),n.find("input.bits").check(t.Bits),n.find("input.me").check(t.Me),a("include_user","From: ",t.IncludeUser),a("include_keyword","Contains: ",t.IncludeKeyword),a("exclude_user","From: ",t.ExcludeUser),a("exclude_startswith","Starts with: ",t.ExcludeStartsWith),a("from_channel","Channel: ",t.FromChannel)}/* Obtain the settings from the module's settings HTML */function getModuleSettings(e){var t=$(e),a={Name:t.find("input.name").val(),Pleb:t.find("input.pleb").is(":checked"),Sub:t.find("input.sub").is(":checked"),VIP:t.find("input.vip").is(":checked"),Mod:t.find("input.mod").is(":checked"),Event:t.find("input.event").is(":checked"),Bits:t.find("input.bits").is(":checked"),Me:t.find("input.me").is(":checked"),IncludeUser:[],IncludeKeyword:[],ExcludeUser:[],ExcludeStartsWith:[],FromChannel:[]};return t.find("input.include_user:checked").each(function(){a.IncludeUser.push($(this).val())}),t.find("input.include_keyword:checked").each(function(){a.IncludeKeyword.push($(this).val())}),t.find("input.exclude_user:checked").each(function(){a.ExcludeUser.push($(this).val())}),t.find("input.exclude_startswith:checked").each(function(){a.ExcludeStartsWith.push($(this).val())}),t.find("input.from_channel:checked").each(function(){a.FromChannel.push($(this).val())}),a}/* Parse a module configuration object from a query string component */function parseModuleConfig(e){for(var t=function(e){return e.map(function(e){return decodeURIComponent(e)})},a=t(e.split(/,/g));7>a.length;)a.push("");/* Upgrade configuration from 6x to 7x */"111111"===a[1]&&(a[1]="1111111");var n=Util.DecodeFlags(a[1],7),r={};return r.Name=a[0],r.Pleb=n[0],r.Sub=n[1],r.VIP=n[2],r.Mod=n[3],r.Event=n[4],r.Bits=n[5],r.Me=n[6],r.IncludeKeyword=a[2]?t(a[2].split(/,/g)):[],r.IncludeUser=a[3]?t(a[3].split(/,/g)):[],r.ExcludeUser=a[4]?t(a[4].split(/,/g)):[],r.ExcludeStartsWith=a[5]?t(a[5].split(/,/g)):[],r.FromChannel=a[6]?t(a[6].split(/,/g)):[],r}/* Format the module configuration object into a query string component */function formatModuleConfig(e){var t=function(e){return e.map(function(e){return encodeURIComponent(e)})},a=[e.Pleb,e.Sub,e.VIP,e.Mod,e.Event,e.Bits,e.Me],n=[e.Name,Util.EncodeFlags(a,!1),t(e.IncludeKeyword).join(","),t(e.IncludeUser).join(","),t(e.ExcludeUser).join(","),t(e.ExcludeStartsWith).join(","),t(e.FromChannel).join(",")];return t(n).join(",")}/* Store the modules' settings in both localStorage and liveStorage */function updateModuleConfig(){var e={};$(".module").each(function(){var t=$(this).attr("id");e[t]=getModuleSettings($(this)),window.liveStorage||(window.liveStorage={}),window.liveStorage[t]=e[t]}),mergeConfigObject(e)}/* End module configuration 1}}} *//* Set the joined channels to the list given */function setChannels(e,t){var a=function(e){return Twitch.FormatChannel(Twitch.ParseChannel(e))},n=t.map(a),r=e.GetJoinedChannels().map(a),d=n.filter(function(e){return-1===r.indexOf(e)}),i=r.filter(function(e){return-1===n.indexOf(e)}),l=!0,o=!1,s=void 0;/* Join all the channels added */try{for(var c,u,g=d[Symbol.iterator]();!(l=(c=g.next()).done);l=!0)u=c.value,e.JoinChannel(u),Content.addNoticeText("Joining "+u);/* Leave all the channels removed */}catch(e){o=!0,s=e}finally{try{!l&&g.return&&g.return()}finally{if(o)throw s}}var p=!0,h=!1,f=void 0;try{for(var m,b,v=i[Symbol.iterator]();!(p=(m=v.next()).done);p=!0)b=m.value,e.LeaveChannel(b),Content.addNoticeText("Leaving "+b)}catch(e){h=!0,f=e}finally{try{!p&&v.return&&v.return()}finally{if(h)throw f}}}/* End configuration section 0}}} *//* Return whether or not the event should be filtered */function shouldFilter(e,t){var a=getModuleSettings(e);if(window.Plugins&&!window.PluginsAreDisabled){var y=Plugins.invoke("shouldFilter",e,t);if(y&&0<y.length){var n=!0,r=!1,d=void 0;try{for(var l,o,c=y[Symbol.iterator]();!(n=(l=c.next()).done);n=!0)if(o=l.value,"boolean"==typeof o)return o;/* Other values: continue the filtering logic */}catch(e){r=!0,d=e}finally{try{!n&&c.return&&c.return()}finally{if(r)throw d}}}}if(t instanceof TwitchChatEvent){var g=t.user||"",p=t.message?t.message.toLowerCase():"",h="pleb";/* NOTE: pleb < sub < vip < mod *//* Includes take priority over excludes */if(t.issub&&(h="sub"),t.isvip&&(h="vip"),t.ismod&&(h="mod"),a.IncludeUser.any(function(e){return e.equalsLowerCase(g)}))return!1;if(a.IncludeKeyword.any(function(e){return-1<p.indexOf(e)}))return!1;/* Role filtering */if(!a.Pleb&&"pleb"==h)return!0;if(!a.Sub&&"sub"==h)return!0;if(!a.VIP&&"vip"==h)return!0;if(!a.Mod&&"mod"==h)return!0;/* Content filtering ("Bits" also filters out cheer effects) */if(!a.Bits&&t.flags.bits)return!0;if(!a.Me&&t.flags.action)return!0;/* Exclude filtering */if(a.ExcludeUser.any(function(e){return e.equalsLowerCase(g)}))return!0;if(a.ExcludeStartsWith.any(function(e){return p.startsWith(e)}))return!0;/* Filtering to permitted channels (default: permit all) */if(0<a.FromChannel.length){var f=!0,m=!1,b=void 0;try{for(var v,S,u=a.FromChannel[Symbol.iterator]();!(f=(v=u.next()).done);f=!0)if(S=v.value,t.channelString.equalsLowerCase(S))return!1}catch(e){m=!0,b=e}finally{try{!f&&u.return&&u.return()}finally{if(m)throw b}}return!0}}else if(t instanceof TwitchEvent&&!a.Event&&("USERNOTICE"===t.command||"NOTICE"===t.command))/* Filter out events and notices */return!0;return!1}/* Populate and show the username context window */function showUserContextWindow(e,a,n){var i=Math.round,o=Number.parseInt;/* Define functions for building elements */function r(e){var t=$("<div class=\"item\"></div>");return"string"==typeof e?t.html(e):t.append(e),t}function d(e,t){var a=$("<a class=\"cw-link\"></a>");return a.attr("id",e),a.text(t),a}var s=$(a),c=$(n),u=c.attr("data-id"),g=c.attr("data-user"),p=c.find(".username").text(),f=c.attr("data-user-id"),m="#"+c.attr("data-channel"),b=c.attr("data-channelid"),v="1"===c.attr("data-subscriber"),S="1"===c.attr("data-mod"),y="1"===c.attr("data-vip"),x="1"===c.attr("data-caster"),C=o(c.attr("data-sent-ts")),L=new Date(C);/* Attributes of the host line */s.html(""),s.attr("data-id",u),s.attr("data-user",g),s.attr("data-user-id",f),s.attr("data-channel",m),s.attr("data-chid",b),s.attr("data-sub",v),s.attr("data-mod",S),s.attr("data-vip",y),s.attr("data-caster",x),s.attr("data-id",u);var E=function(e){return $("<span class=\"em pad\"></span>").html(e)},k=c.find(".username"),T=k.attr("class").escape(),H=k.attr("style").escape();/* Add user's display name *//* Add link to timeout user */if(s.append(r("<span class=\""+T+"\" style=\""+H+"\">"+p+"</span>"+" in <span class=\"em\">"+m+"</span>")),e.IsMod(m)){var I=$("<div class=\"cw-timeout\">Timeout:</div>"),P=!0,M=!1,A=void 0;try{for(var N,_=["1s","10s","60s","10m","30m","1h","12h","24h"][Symbol.iterator]();!(P=(N=_.next()).done);P=!0){var F=N.value,D=d("cw-timeout-"+g+"-"+F,F);D.addClass("cw-timeout-dur"),D.attr("data-channel",m),D.attr("data-user",g),D.attr("data-duration",F),D.click(function(){var t=$(this).attr("data-channel"),n=$(this).attr("data-user"),r=$(this).attr("data-duration");e.Timeout(t,n,r),Util.Log("Timed out user "+n+" from "+t+" for "+r),$(a).fadeOut()}),I.append(D)}}catch(e){M=!0,A=e}finally{try{!P&&_.return&&_.return()}finally{if(M)throw A}}s.append(I)}/* Add link which places "/ban <user>" into the chat textbox */if(e.IsMod(m)){var Y=d("cw-ban-"+g,"Ban");Y.addClass("cw-ban-user"),Y.attr("data-channel",m),Y.attr("data-user",g),Y.click(function(){$("#txtChat").val("/ban "+$(this).attr("data-user"))}),s.append(Y)}/* Add other information */var O=Util.FormatDate(L),G=Util.FormatInterval((Date.now()-C)/1e3);/* Add roles (and ability to remove roles, for the caster) */if(s.append(r("Sent: "+O+" ("+G+" ago)")),s.append(r("UserID: "+f)),s.append(r("MsgUID: "+u)),S||y||v||x){var U=r("User Role: "),R=[];if(S&&R.push(E("Mod")),y&&R.push(E("VIP")),v&&R.push(E("Sub")),x&&R.push(E("Host")),0<R.length){U.append(R[0]);var W=!0,j=!1,V=void 0;try{for(var z,B,K=R.slice(1)[Symbol.iterator]();!(W=(z=K.next()).done);W=!0)B=z.value,U.append(", "),U.append(B)}catch(e){j=!0,V=e}finally{try{!W&&K.return&&K.return()}finally{if(j)throw V}}s.append(U)}e.IsCaster(m)&&!e.IsUIDSelf(f)&&(S&&s.append(r(d("cw-unmod","Remove Mod"))),y&&s.append(r(d("cw-unvip","Remove VIP"))))}/* Add the ability to add roles (for the caster) */e.IsCaster(m)&&!e.IsUIDSelf(f)&&(!S&&s.append(r(d("cw-make-mod","Make Mod"))),!y&&s.append(r(d("cw-make-vip","Make VIP")))),Util.Trace("Showing ucw for",c);var X=c.offset(),q=i(X.top)+c.outerHeight()+2,t=i(X.left),l=s.outerWidth(),w=s.outerHeight(),h={top:q,left:t,width:l,height:w};Util.ClampToScreen(h),delete h.width,delete h.height,s.fadeIn().offset(h)}/* Set or unset transparency */function updateTransparency(e){/* exported updateTransparency */var t=[];try{var a=Util.CSS.GetSheet("main.css"),n=Util.CSS.GetRule(a,":root"),r=!0,d=!1,i=void 0;/* Find the prop="--<name>-color" rules */try{for(var l,o,s=Util.CSS.GetPropertyNames(n)[Symbol.iterator]();!(r=(l=s.next()).done);r=!0)o=l.value,o.match(/^--[a-z-]+-color$/)&&t.push(o)}catch(e){d=!0,i=e}finally{try{!r&&s.return&&s.return()}finally{if(d)throw i}}}catch(a){/* Unable to enumerate properties; use hard-coded ones */Util.ErrorOnce("Failed getting main.css :root",a),t=["--body-color","--header-color","--menudiv-color","--module-color","--odd-line-color","--sub-color","--chat-color","--textarea-color"]}var c=!0,u=!1,g=void 0;try{for(var p,h,f=t[Symbol.iterator]();!(c=(p=f.next()).done);c=!0)h=p.value,e?(Util.CSS.SetProperty(h,"transparent"),$(".module").addClass("transparent"),$("body").addClass("transparent")):(Util.CSS.SetProperty(h,"var("+h+"-default)"),$(".module").removeClass("transparent"),$("body").removeClass("transparent"))}catch(e){u=!0,g=e}finally{try{!c&&f.return&&f.return()}finally{if(u)throw g}}}/* Set the colorscheme to dark */function setDarkScheme(){/* exported setDarkScheme */$("body").removeClass("light").addClass("dark"),$("#btnSettings").attr("src",AssetPaths.SETTINGS)}/* Set the colorscheme to light */function setLightScheme(){/* exported setLightScheme */$("body").removeClass("dark").addClass("light"),$("#btnSettings").attr("src",AssetPaths.SETTINGS_LIGHT)}/* Set or clear window notification badge */function setNotify(){var e=!(0<arguments.length&&arguments[0]!==void 0)||arguments[0],t=e?AssetPaths.FAVICON_ALERT:AssetPaths.FAVICON;/* exported setNotify */$("link[rel=\"shortcut icon\"]").attr("href",t)}/* Called once when the document loads */function doLoadClient(){var c=Number.parseInt,u=Math.clamp;/* Function for syncing configuration with HTMLGen */function e(){var e=!0,t=!1,a=void 0;try{for(var n,r=Object.entries(getConfigObject())[Symbol.iterator]();!(e=(n=r.next()).done);e=!0){var d=n.value,i=_slicedToArray(d,2),l=i[0],o=i[1];g.get("HTMLGen").setValue(l,o)}}catch(e){t=!0,a=e}finally{try{!e&&r.return&&r.return()}finally{if(t)throw a}}}/* Close the main settings window */function t(){updateModuleConfig(),$("#settings").fadeOut()}/* Open the main settings window */function a(){var e=getConfigObject(!0);$("#txtChannel").val(e.Channels.join(",")),$("#txtNick").val(e.Name||Strings.NAME_AUTOGEN),e.Pass&&0<e.Pass.length&&($("#txtPass").attr("disabled","disabled").hide(),$("#txtPassDummy").show()),$("#selDebug").val(""+e.Debug),$("#settings").fadeIn()}/* Toggle the main settings window */function n(){$("#settings").is(":visible")?t():a()}/* Close a module's settings window */function r(e){updateModuleConfig();var t=$(e).find(".settings"),a=t.siblings("input.name"),n=t.siblings("label.name");a.hide(),n.html(a.val()).show(),t.fadeOut()}/* Open a module's settings window */function d(e){var t=$(e).find(".settings"),a=t.siblings("input.name"),n=t.siblings("label.name");n.hide(),a.val(n.html()).show(),t.fadeIn()}/* Toggle a module's settings window */function i(e){var t=$(e).find(".settings");t.is(":visible")?r(e):d(e)}/* Reset chat auto-completion variables */function l(){var e=$("#txtChat");e.attr("data-complete-text",""),e.attr("data-complete-pos","-1"),e.attr("data-complete-index","0")}/* Reset chat history recall */function o(){$("#txtChat").attr("data-hist-index","-1")}/* Initialize chat auto-completion and history *//* Open the settings builder page */function s(){Util.Open(AssetPaths.BUILDER_WINDOW,"_blank",{})}/* Add command to open the settings builder page *//* exported doLoadClient */var g=void 0,p={};/* Hook Logger messages to display in chat *//* Disable configured events */if(Util.Logger.addHook(function(){if(Util.DebugLevel>=Util.LEVEL_DEBUG){for(var e,t=arguments.length,a=Array(2<t?t-2:0),n=2;n<t;n++)a[n-2]=arguments[n];var r=(e=Util.Logger).stringify.apply(e,a);Content.addErrorText("ERROR: "+r)}},"ERROR"),Util.Logger.addHook(function(){for(var e=arguments.length,t=Array(2<e?e-2:0),a=2;a<e;a++)t[a-2]=arguments[a];if(1===t.length&&t[0]instanceof TwitchEvent)Util.DebugLevel>=Util.LEVEL_TRACE&&Content.addNoticeText("WARNING: "+JSON.stringify(t[0]));else if(Util.DebugLevel>=Util.LEVEL_DEBUG){var n,r=(n=Util.Logger).stringify.apply(n,t);Content.addNoticeText("WARNING: "+r)}},"WARN"),Util.Logger.addHook(function(){if(Util.DebugLevel>=Util.LEVEL_TRACE){for(var e,t=arguments.length,a=Array(2<t?t-2:0),n=2;n<t;n++)a[n-2]=arguments[n];var r=(e=Util.Logger).stringify.apply(e,a);Content.add("DEBUG: "+r)}},"DEBUG"),Util.Logger.addHook(function(){if(Util.DebugLevel>=Util.LEVEL_TRACE){for(var e,t=arguments.length,a=Array(2<t?t-2:0),n=2;n<t;n++)a[n-2]=arguments[n];var r=(e=Util.Logger).stringify.apply(e,a);Content.add("TRACE: "+r)}},"TRACE"),Util.DebugLevel<Util.LEVEL_TRACE&&(Util.Logger.addFilter(/ws (send|recv)>.+(PING|PONG) :tmi.twitch.tv/),Util.Logger.addFilter(/tmi.twitch.tv (JOIN|PART) #/)),$("#txtNick").val(),$("#txtPass").val(),ChatCommands.add("config",function(e,a){var n=Number.parseFloat,r=getConfigObject(!0),d=0<a.length?a[0]:"";if(0===a.length){var se=[];Content.addHelp("<em>Global Configuration Values:</em>");var i=!0,l=!1,o=void 0;try{for(var s,u=Object.entries(r)[Symbol.iterator]();!(i=(s=u.next()).done);i=!0){var p=s.value,h=_slicedToArray(p,2),f=h[0],m=h[1],b=f,v="object"===("undefined"==typeof m?"undefined":_typeof(m))?JSON.stringify(m):""+m;"Layout"===f?v=FormatLayout(m):"ClientID"===f?v="Omitted for security; use //config clientid to show":"Pass"===f?v="Omitted for security; use //config pass to show":"object"===("undefined"==typeof m?"undefined":_typeof(m))&&m.Name&&0<m.Name.length&&(b=v=null,se.push([f,m])),null!==b&&Content.addHelpLine(b,v)}}catch(e){l=!0,o=e}finally{try{!i&&u.return&&u.return()}finally{if(l)throw o}}Content.addHelp("<em>Window Configuration Values:</em>");var S=!0,y=!1,x=void 0;try{for(var C,L=se[Symbol.iterator]();!(S=(C=L.next()).done);S=!0){var E=C.value,k=_slicedToArray(E,2),T=k[0],w=k[1],H=function(t){return"&quot;"+t+"&quot"},I="&quot;"+w.Name+"&quot;";Content.addHelpText("Module "+("<span class=\"arg\">"+T+"</span>")+": "+I);var P=!0,M=!1,A=void 0;try{for(var N,_=Object.entries(w)[Symbol.iterator]();!(P=(N=_.next()).done);P=!0){var F=N.value,D=_slicedToArray(F,2),O=D[0],G=D[1];"Name"!==O&&Content.addHelpLine(O,H(G))}}catch(e){M=!0,A=e}finally{try{!P&&_.return&&_.return()}finally{if(M)throw A}}}}catch(e){y=!0,x=e}finally{try{!S&&L.return&&L.return()}finally{if(y)throw x}}}else if("help"===d)Content.addHelpLine("//config","Show and manipulate configuration"),Content.addHelpText("//config parameters:"),Content.addHelpLine("export","Export *all* of localStorage to a new tab (contains passwords!)"),Content.addHelpLine("purge","Clear localStorage (cannot be undone!)"),Content.addHelpLine("clientid","Display ClientID"),Content.addHelpLine("pass","Dislay OAuth token (if one is present)"),Content.addHelpLine("url","Generate a URL from the current configuration"),Content.addHelpText("//config url parameters (can be used in any order):"),Content.addHelpLine("git","Force URL to target github.io"),Content.addHelpLine("text","Force URL to be un-encoded"),Content.addHelpLine("auth","Include passwords in URL"),Content.addHelpLine("tag=&lt;value&gt;","Set the tag to &lt;value&gt;"),Content.addHelpText("//config set <key> <value>: Change <key> to <value> (dangerous!)"),Content.addHelpText("//config setobj <key> <value>: Change <key> to JSON-encoded <value> (dangerous!)"),Content.addHelpText("//config unset <key>: Remove <key> (dangerous!)");else if("export"===d)Util.Open(AssetPaths.CONFIG_EXPORT_WINDOW,"_blank",{});else if("purge"===d)Util.SetWebStorage({}),window.liveStorage={},Content.addNoticeText("Purged storage \""+Util.GetWebStorageKey()+"\"");else if("clientid"===d)Content.addHelpLine("ClientID",r.ClientID);else if("pass"===d)Content.addHelpLine("Pass",r.Pass);else if("url"===d){/* Generate a URL with the current configuration, omitting items
       * left at default values *//* Base URL, query string array, and function to add items */var U=-1<a.indexOf("git")?GIT_URL:CUR_URL,R=[],W=function(e,t){return R.push(e+"="+encodeURIComponent(t))};0<r.Debug&&W("debug",r.Debug),r.__clientid_override&&W("clientid",r.ClientID),W("channels",r.Channels.join(",")),r.NoAssets&&W("noassets",r.NoAssets),r.NoFFZ&&W("noffz",r.NoFFZ),r.NoBTTV&&W("nobttv",r.NoBTTV),r.HistorySize&&W("hmax",r.HistorySize);var j=!0,V=!1,z=void 0;try{for(var B,K,X=Object.keys(getModules())[Symbol.iterator]();!(j=(B=X.next()).done);j=!0)K=B.value,W(K,formatModuleConfig(r[K]))}catch(e){V=!0,z=e}finally{try{!j&&X.return&&X.return()}finally{if(V)throw z}}W("layout",FormatLayout(r.Layout)),r.Transparent&&W("trans","1"),r.NoAutoReconnect&&W("norec","1");var q=Util.CSS.GetProperty("--body-font-size"),Y=Util.CSS.GetProperty("--body-font-size-default");if(q!==Y&&W("size",q.replace(/[^0-9]/g,"")),r.Plugins&&W("plugins","1"),r.MaxMessages!==TwitchClient.DEFAULT_MAX_MESSAGES&&W("max",""+r.MaxMessages),r.Font&&W("font",r.Font),r.Scroll&&W("scroll","1"),r.ShowClips&&W("clips","1"),-1<a.indexOf("auth")&&(W("user",r.Name),W("pass",r.Pass)),r.DisableEffects&&W("disable",r.DisableEffects.join(",")),r.EnableEffects&&W("enable",r.EnableEffects.join(",")),r.PluginConfig&&W("plugincfg",JSON.stringify(r.PluginConfig)),"dark"===r.ColorScheme?W("scheme","dark"):"light"===r.ColorScheme&&W("scheme","light"),r.EnableForce&&W("force","1"),r.Fanfare&&W("fanfare",JSON.stringify(r.Fanfare)),r.Highlight||g.get("HTMLGen").highlightMatches){var ce=r.Highlight||[];ce=ce.concat(g.get("HTMLGen").highlightMatches||[]),W("highlight",ce.map(function(e){return""+e}).join(","))}/* Append a tag */var Q=r.tag?r.tag:"",J=!0,Z=!1,ee=void 0;try{for(var te,ae,ne=a.slice(1)[Symbol.iterator]();!(J=(te=ne.next()).done);J=!0)ae=te.value,ae.startsWith("tag=")&&(Q=ae.substr(4))}catch(e){Z=!0,ee=e}finally{try{!J&&ne.return&&ne.return()}finally{if(Z)throw ee}}Q&&W("tag",Q),U+=a.includes("text")?"?"+R.join("&"):"?base64="+encodeURIComponent(btoa(R.join("&"))),Content.addHelp($("<a></a>").attr("href",U).text(U))}else if(("set"===d||"setobj"===d)&&2<a.length){/* Allow changing configuration by command (dangerous) */var re=a[1],de=a.slice(2).join(" "),ie=null;ie="setobj"===d?JSON.parse(de):"true"===de||"false"!==de&&("Infinity"===de?1/0:"-Infinity"===de?-Infinity:"NaN"===de?NaN:de.match(/^[+-]?(?:\d|[1-9]\d*)$/)?c(de):de.match(/^[-+]?(?:\d*\.\d+|\d+)$/)?n(de):de);var ue=JSON.stringify(ie);if(Util.ObjectHas(r,re)){var le=Util.ObjectGet(r,re),oe=JSON.stringify(le);Content.addHelpText("Changing "+re+" from \""+oe+"\" to \""+ue+"\""),Content.addHelpLine(re,oe),Content.addHelpLine(re,ue),Util.ObjectSet(r,re,ie),mergeConfigObject(r)}else Content.addHelpText("Adding key "+re+" with value \""+ue+"\""),Content.addHelpLine(re,ue),Util.ObjectSet(r,re,ie),mergeConfigObject(r)}else if("unset"===d&&1<a.length){var ge=a[1];Util.ObjectRemove(r,ge)?(Content.addHelpText("Removed key "+ge+" from localStorage"),Util.SetWebStorage(r)):Content.addHelpText("Failed to remove key "+ge+" from localStorage"),window.liveStorage&&(Util.ObjectRemove(window.liveStorage,ge)?Content.addHelpText("Removed key "+ge+" from liveStorage"):Content.addHelpText("Failed to removed key "+ge+" from liveStorage"))}else if(Util.ObjectHas(r,d))Content.addHelpText("Configuration:"),Content.addHelpLine(d,JSON.stringify(Util.ObjectGet(r,d)));else{Content.addErrorText("Unknown config command or key "+("\""+d+"\""),!0)}},"Obtain and modify configuration information; use //config help for details"),function(){var e=getConfigObject(!0);g=new TwitchClient(e),Util.DebugLevel=e.Debug,e.Pass&&0<e.Pass.length?document.title+=" - Authenticated":(document.title+=" - Read-Only",e.Layout.Chat&&($("#txtChat").attr("placeholder",Strings.ANON_PLACEHOLDER+": "+Strings.AUTH_PLACEHOLDER),Util.CSS.SetProperty("--chat-border","#cd143c"))),p=getConfigObject(),p.Plugins=!!e.Plugins,p.Pass=p.ClientID=null,delete p.Pass,delete p.ClientID}(),$(".module").each(function(){setModuleSettings(this,p[$(this).attr("id")])}),p.DisableEffects){var h=!0,f=!1,m=void 0;try{for(var b,v,S=p.EnableEffects[Symbol.iterator]();!(h=(b=S.next()).done);h=!0)v=b.value,CSSCheerStyles[v]&&(CSSCheerStyles[v]._disabled=!0)}catch(e){f=!0,m=e}finally{try{!h&&S.return&&S.return()}finally{if(f)throw m}}}/* Enable configured effects */if(p.EnableEffects){var y=!0,x=!1,C=void 0;try{for(var L,E,k=p.EnableEffects[Symbol.iterator]();!(y=(L=k.next()).done);y=!0)E=L.value,CSSCheerStyles[E]&&(CSSCheerStyles[E]._disabled=!1)}catch(e){x=!0,C=e}finally{try{!y&&k.return&&k.return()}finally{if(x)throw C}}}/* Simulate clicking cbTransparent if config.Transparent is set */if(p.Transparent?(updateTransparency(!0),$("#cbTransparent").check()):$("#cbTransparent").uncheck(),p.Size&&Util.CSS.SetProperty("--body-font-size",p.Size),p.Font&&Util.CSS.SetProperty("--body-font",p.Font),p.Scroll?($(".module .content").css("overflow-y","scroll"),$("#cbScroll").check()):$("#cbScroll").uncheck(),0===p.Channels.length&&$("#settings").fadeIn(),p.ShowClips?$("#cbClips").check():$("#cbClips").uncheck(),p.EnableForce?$("#cbForce").check():$("#cbForce").uncheck(),"dark"===p.ColorScheme?setDarkScheme():"light"===p.ColorScheme&&setLightScheme(),p.NoAnim?$("#cbAnimCheers").uncheck():$("#cbAnimCheers").check(),$("#txtBGStyle").val(""),p.Font?$("#txtFont").val(p.Font):$("#txtFont").val(Util.CSS.GetProperty("--body-font")),p.Size?$("#txtFontSize").val(p.Size):$("#txtFontSize").val(Util.CSS.GetProperty("--body-font-size")),p.tag&&$("#txtTag").val(p.tag),g.set("HTMLGen",new HTMLGenerator(g,p)),g.set("Fanfare",new Fanfare(g,p)),p.Highlight){var T=!0,w=!1,H=void 0;try{for(var I,P,M=p.Highlight[Symbol.iterator]();!(T=(I=M.next()).done);T=!0)P=I.value,g.get("HTMLGen").addHighlightMatch(P)}catch(e){w=!0,H=e}finally{try{!T&&M.return&&M.return()}finally{if(w)throw H}}}/* Construct the plugins */p.Plugins?Plugins.loadAll(g,p):Plugins.disable(),Util.DebugLevel>=Util.LEVEL_DEBUG&&(window.client=g),ChatCommands.addHelpText("Moderator commands:",{literal:!0}),ChatCommands.addHelpText("!tfc reload: Reload the page",{literal:!0,command:!0}),ChatCommands.addHelpText("!tfc force-reload: Reload the page, discarding cache",{literal:!0,command:!0}),ChatCommands.addHelpText("!tfc nuke: Completely clear the chat",{literal:!0,command:!0}),ChatCommands.addHelpText("!tfc nuke <user>: Clear messages sent by <user>",{args:!0,command:!0}),ChatCommands.addHelpText("!tfc ffdemo: Demonstrate fanfares",{literal:!0,command:!0}),ChatCommands.addHelpText("!tfc ffcheerdemo: Demonstrate default cheer fanfare",{literal:!0,command:!0}),ChatCommands.addHelpText("!tfc ffsubdemo: Demonstrate default sub fanfare",{literal:!0,command:!0}),l(),o(),ChatCommands.add("builder",function(){s()},"Open the configuration builder wizard"),$("#txtChat").keydown(function(a){var e=Number.isNaN,n=event.target,t=$(n);if(a.shiftKey)l(),o();else{if("Enter"===a.key)return 0<n.value.trim().length&&(ChatCommands.isCommandStr(n.value)?ChatCommands.execute(n.value,g):g.SendMessageToAll(n.value),g.AddHistory(n.value),n.value="",l(),o()),a.preventDefault(),!1;if("Process"===a.key&&"Tab"===a.code);else{if("Tab"===a.key){/* Tab completion *//* TODO: Complete command arguments */var r=t.attr("data-complete-text")||n.value,s=Util.ParseNumber(t.attr("data-complete-pos")),c=Util.ParseNumber(t.attr("data-complete-index"));(e(s)||-1===s)&&(s=n.selectionStart),e(c)&&(c=0);var d={orig_text:r,orig_pos:s,curr_text:n.value,curr_pos:n.selectionStart,index:c};return d=ChatCommands.complete(g,d),t.attr("data-complete-text",d.orig_text),t.attr("data-complete-pos",d.orig_pos),t.attr("data-complete-index",d.index),n.value=d.curr_text,requestAnimationFrame(function(){n.selectionStart=d.curr_pos,n.selectionEnd=d.curr_pos}),o(),a.preventDefault(),!1}if("ArrowUp"===a.key||"ArrowDown"===a.key){/* Handle traversing message history */var p=Util.ParseNumber(t.attr("data-hist-index")),h="ArrowUp"===a.key?1:-1;p=u(p+h,-1,g.GetHistoryLength()-1);var f=g.GetHistoryItem(p);null!==f&&(n.value=f.trim()),t.attr("data-hist-index",""+p),requestAnimationFrame(function(){n.selectionStart=n.value.length,n.selectionEnd=n.value.length}),l()}else l(),o()}}}),$("#settings").keyup(function(t){"Enter"===t.key&&n()}),$("#btnSettings").click(function(){n()}),$("#btnSettingsHelp").click(function(){Util.Open(AssetPaths.HELP_WINDOW,"_blank",{})}),$("#btnSettingsBuilder").click(function(){s()}),onChange($("#txtChannel"),function(){setChannels(g,$(this).val().split(",")),mergeConfigObject({Channels:g.GetJoinedChannels()})}),$("#cbScroll").change(function(){var e=$(this).is(":checked");mergeConfigObject({Scroll:e}),$(".module .content").css("overflow-y",e?"scroll":"hidden")}),$("#cbTransparent").change(function(){var t=$(this).is(":checked");updateTransparency(t),e()}),$("#cbClips").change(function(){mergeConfigObject({ShowClips:$(this).is(":checked")}),e()}),$("#cbForce").change(function(){mergeConfigObject({EnableForce:$(this).is(":checked")}),e()}),$("#selDebug").change(function(){var e=parseInt($(this).val());Util.Log("Changing debug level from "+Util.DebugLevel+" to "+e),Util.DebugLevel=e}),$("#btnReconnect").click(function(){g.Connect()}),$("#btnAdvanced, #btnAdvHide").click(function(){$("#advSettings").slideToggle()}),$("#cbAnimCheers").change(function(){mergeConfigObject({NoAnim:!$(this).is(":checked")}),e()}),onChange($("#txtBGStyle"),function(){$(".module").css("background-image",$(this).val())}),onChange($("#txtFont"),function(){var e=$(this).val();e&&("default"===e?Util.CSS.SetProperty("--body-font","var(--body-font-default)"):Util.CSS.SetProperty("--body-font",e))}),onChange($("#txtFontSize"),function(){var e=$(this).val();e&&("default"===e?Util.CSS.SetProperty("--body-font-size","var(--body-font-size-default)"):Util.CSS.SetProperty("--body-font-size",e))}),onChange($("#txtTag"),function(){mergeConfigObject({tag:$(this).val()})}),$(".module .header input.name").keyup(function(t){var e=$(this).parentsUntil(".column").last();"Enter"===t.key?r(e):"Escape"===t.key&&(e.find("input.name").val(e.find("label.name").html()),r(e))}),$(".module .header .clear-link").click(function(){$(this).parentsUntil(".column").find(".line-wrapper").remove()}),$(".module .settings input[type=\"text\"]").keyup(function(t){if("Enter"===t.key){var l=$(this).val();if(0<l.length){var e=$(this).closest("li"),a=e.attr("class").replace("textbox","").trim(),n=g.get("HTMLGen").checkbox(l,null,a,!0),d=e.find("label").html(),i=$("<li><label>"+n+d+" "+l+"</label></li>");e.before(i),$(this).val(""),updateModuleConfig()}}else"Escape"===t.key&&r($(this).parentsUntil(".column").last())}),$(document).keyup(function(t){if("ScrollLock"===t.key){/* ScrollLock: pause or resume auto-scroll */var e=$(".module .content"),a=e.attr("data-no-scroll");a?(e.removeAttr("data-no-scroll"),Util.Log("Auto-scroll enabled"),Content.addHelpText("Auto-scroll enabled")):(e.attr("data-no-scroll","1"),Util.Log("Auto-scroll disabled"),Content.addHelpText("Auto-scroll disabled"))}else if("Escape"===t.key){$("#settings").is(":visible")&&$("#settings").fadeOut();var n=!0,d=!1,i=void 0;try{for(var l,o,c=Object.values(getModules())[Symbol.iterator]();!(n=(l=c.next()).done);n=!0)o=l.value,$(o).find(".settings").is(":visible")&&r($(o))}catch(e){d=!0,i=e}finally{try{!n&&c.return&&c.return()}finally{if(d)throw i}}}else"F1"===t.key&&/* F1: open configuration help window */s()}),$(document).click(function(a){var e=$(a.target),n=!0,d=!1,l=void 0;/* Clicking on or off of the module settings button or box */try{for(var o,s=Object.values(getModules())[Symbol.iterator]();!(n=(o=s.next()).done);n=!0){var c=o.value,u=$(c),p=u.find(".menu"),h=u.find(".header"),f=u.find(".settings");Util.PointIsOn(a.clientX,a.clientY,p)?i(u):f.is(":visible")&&!Util.PointIsOn(a.clientX,a.clientY,f)&&!Util.PointIsOn(a.clientX,a.clientY,h)&&r(u)}/* Clicking off the main settings window */}catch(e){d=!0,l=e}finally{try{!n&&s.return&&s.return()}finally{if(d)throw l}}var m=$("#settings");m.is(":visible")&&!Util.PointIsOn(a.clientX,a.clientY,m)&&t();/* Clicking on the username context window */var b=$("#userContext");if(Util.PointIsOn(a.clientX,a.clientY,b)){var v=b.attr("data-channel"),S=b.attr("data-user"),y=b.attr("data-user-id");g.IsUIDSelf(y)||("cw-unmod"===e.attr("id")?(Util.Log("Unmodding "+S+" in "+v),g.SendMessage(v,"/unmod "+S)):"cw-unvip"===e.attr("id")?(Util.Log("Removing VIP for "+S+" in "+v),g.SendMessage(v,"/unvip "+S)):"cw-make-mod"===e.attr("id")?(Util.Log("Modding "+S+" in "+v),g.SendMessage(v,"/mod "+S)):"cw-make-vip"===e.attr("id")&&(Util.Log("VIPing "+S+" in "+v),g.SendMessage(v,"/vip "+S)))}else if("1"===e.attr("data-username")){/* Clicked on a username; show context window */var x=e.parent();b.is(":visible")?b.attr("data-user-id")===x.attr("data-user-id")?b.fadeOut():showUserContextWindow(g,b,x):showUserContextWindow(g,b,x)}else b.is(":visible")&&/* Clicked somewhere else: close context window */b.fadeOut();/* Clicking on a "Reconnect" link */"1"===e.attr("data-reconnect")&&(Content.addNoticeText("Reconnecting..."),g.Connect())}),g.bind("twitch-open",function(){$(".loading").remove(),$("#debug").hide(),Util.DebugLevel>=Util.LEVEL_DEBUG&&(g.IsAuthed()?Content.addInfoText("Connected (authenticated)"):Content.addInfoText("Connected (unauthenticated)")),0===getConfigValue("Channels").length&&Content.addInfoText("No channels configured; type //join <channel> to join one!")}),g.bind("twitch-close",function(t){var e=t.object.event.code,a=t.object.event.reason,n="(code "+e+" "+Util.WSStatus[e]+")";a&&(n="(code "+e+" "+Util.WSStatus[e]+": "+a+")"),getConfigValue("NoAutoReconnect")?Content.addErrorText("Connection closed "+n+" "+Strings.RECONNECT):(Content.addErrorText("Connection closed "+n+"; reconnecting in 5 seconds..."),!g.connecting&&window.setTimeout(function(){g.Connect()},5e3))}),g.bind("twitch-joined",function(t){var e=getConfigValue("Layout");e.Slim||Content.addInfoText("Joined "+Twitch.FormatChannel(t.channel))}),g.bind("twitch-parted",function(t){var e=getConfigValue("Layout");e.Slim||Content.addInfoText("Left "+Twitch.FormatChannel(t.channel))}),g.bind("twitch-notice",function(t){var e=Twitch.FormatChannel(t.channel),a=t.message;Content.addNoticeText(e+": "+a),"cmds_available"===t.noticeMsgId&&Content.addInfoText("Use //help to see Twitch Filtered Chat commands")}),g.bind("twitch-error",function(t){Util.Error(t);var e=t.user,a=t.values.command,n=t.message;Content.addErrorText("Error for "+e+": "+a+": "+n)}),g.bind("twitch-message",function(t){Util.DebugLevel>=Util.LEVEL_TRACE&&(t instanceof TwitchEvent?Content.addPreText(t.repr()):Content.addPreText(JSON.stringify(t)))}),g.bind("twitch-streaminfo",function(t){var e=getConfigValue("Layout"),a=g.GetChannelInfo(t.channelString)||{};if(e&&!e.Slim)if(a.online)try{/* Helix changes:
           * name = cinfo.stream.user_name
           * game = cinfo.stream.game_id (translate to game name)
           * viewers = cinfo.stream.viewer_count */var n=a.stream.channel.display_name,r=a.stream.game,d=a.stream.viewers;Content.addNotice(Strings.StreamInfo(n,r,d)),a.stream.channel.status&&Content.addNoticeText(a.stream.channel.status)}catch(e){Util.ErrorOnly("Failed to obtain stream information:",a),Util.Error(e),Content.addNotice(Strings.StreamOnline(t.channelString))}else Content.addNotice(Strings.StreamOffline(t.channelString))}),g.bind("twitch-chat",function(t){if(t instanceof TwitchChatEvent){var o="string"==typeof t.message?t.message:"";if(t.flags&&t.flags.mod&&-1<o.indexOf(" ")){var s=o.split(" ");if("!tfc"===s[0]){if("reload"===s[1])location.reload();else if("force-reload"===s[1])location.reload(!0);else if("clear"===s[1])$(".content").children().remove();else if("nuke"===s[1]){if(s[2]&&1<s[2].length){var u=CSS.escape(s[2].toLowerCase());$("[data-user=\""+u+"\"]").parent().remove()}else $(".content").children().remove();}else if("ffdemo"===s[1]){var p=g.get("Fanfare");p._onChatEvent(g,{bits:1e3},!0),p._onSubEvent(g,{kind:TwitchSubEvent.KIND_SUB,plan:TwitchSubEvent.PLAN_TIER1},!0)}else if("ffcheerdemo"===s[1]){var h=g.get("Fanfare");h._onChatEvent(g,{bits:1e3},!0)}else if("ffsubdemo"===s[1]){var f=g.get("Fanfare");f._onSubEvent(g,{kind:TwitchSubEvent.KIND_SUB,plan:TwitchSubEvent.PLAN_TIER1},!0)}return}}}$(".module").each(function(){var e=g.get("HTMLGen");if(!shouldFilter($(this),t)){var a=$(this).find(".content"),n=e.gen(t),r=n.find(".message[data-clip]");if(0<r.length){var d=r.attr("data-clip");g.GetClip(d).then(function(t){g.GetGame(t.game_id).then(function(n){Content.addHTML(e.genClip(d,t,n),a)})})}Content.addHTML(n,a)}});/* Avoid flooding the DOM with stale chat messages */var e=getConfigValue("MaxMessages"),a=!0,n=!1,r=void 0;try{for(var d,i,l=$(".content")[Symbol.iterator]();!(a=(d=l.next()).done);a=!0)for(i=d.value;$(i).find(".line-wrapper").length>e;)$(i).find(".line-wrapper").first().remove()}catch(e){n=!0,r=e}finally{try{!a&&l.return&&l.return()}finally{if(n)throw r}}}),g.bind("twitch-clearchat",function(t){if(t.flags["target-user-id"]){/* Moderator timed out a user */var e=CSS.escape(t.flags["room-id"]),a=CSS.escape(t.flags["target-user-id"]),n=$(".chat-line[data-channel-id=\""+e+"\"][data-user-id=\""+a+"\"]");n.parent().remove()}else/* Moderator cleared the chat */$("div.content").find(".line-wrapper").remove()}),g.bind("twitch-clearmsg",function(t){Util.StorageAppend(LOG_KEY,t),Util.Warn("Unhandled CLEARMSG:",t)}),g.bind("twitch-sub",function(t){Util.StorageAppend(LOG_KEY,t),Content.addHTML(g.get("HTMLGen").sub(t))}),g.bind("twitch-resub",function(t){/* Display the resub message, if one is present */if(Util.StorageAppend(LOG_KEY,t),Content.addHTML(g.get("HTMLGen").resub(t)),t.message){var e=g.get("HTMLGen").gen(t);e.addClass("message"),e.addClass("sub-message"),e.addClass("sub-user-message"),Content.addHTML(e)}}),g.bind("twitch-giftsub",function(t){Util.StorageAppend(LOG_KEY,t),Content.addHTML(g.get("HTMLGen").giftsub(t))}),g.bind("twitch-anongiftsub",function(t){Util.StorageAppend(LOG_KEY,t),Content.addHTML(g.get("HTMLGen").anongiftsub(t))}),g.bind("twitch-raid",function(t){Util.StorageAppend(LOG_KEY,t),Content.addHTML(g.get("HTMLGen").raid(t))}),g.bind("twitch-newuser",function(t){Util.StorageAppend(LOG_KEY,t);var e=g.get("HTMLGen"),a=e.newUser(t);a.find(".message").addClass("effect-rainbow").addClass("effect-disco"),Content.addHTML(a),Content.addHTML(e.gen(t))}),g.bind("twitch-rewardgift",function(t){Util.StorageAppend(LOG_KEY,t),Content.addHTML(g.get("HTMLGen").rewardGift(t))}),g.bind("twitch-mysterygift",function(t){Util.StorageAppend(LOG_KEY,t),Content.addHTML(g.get("HTMLGen").mysteryGift(t))}),g.bind("twitch-giftupgrade",function(t){Util.StorageAppend(LOG_KEY,t),Content.addHTML(g.get("HTMLGen").giftUpgrade(t))}),g.bind("twitch-primeupgrade",function(t){Util.StorageAppend(LOG_KEY,t),Content.addHTML(g.get("HTMLGen").giftUpgrade(t))}),g.bind("twitch-anongiftupgrade",function(t){Util.StorageAppend(LOG_KEY,t),Content.addHTML(g.get("HTMLGen").giftUpgrade(t))}),g.bind("twitch-otherusernotice",function(t){Util.StorageAppend(LOG_KEY,t),Util.Warn("Unknown USERNOTICE",t)}/* TODO: unraid, bitsbadgetier */),g.bind("twitch-reconnect",function(){}),g.bind("twitch-join",function(){}),g.bind("twitch-part",function(){}),g.bind("twitch-hosttarget",function(){}),g.bind("twitch-userstate",function(){}),g.bind("twitch-roomstate",function(){}),g.bind("twitch-globaluserstate",function(){}),g.bind("twitch-usernotice",function(){}),g.bind("twitch-ack",function(){}),g.bind("twitch-ping",function(){}),g.bind("twitch-names",function(){}),g.bind("twitch-topic",function(){}),g.bind("twitch-privmsg",function(){}),g.bind("twitch-whisper",function(){}),g.bind("twitch-mode",function(){}),g.bind("twitch-other",function(){}),g.bindDefault(function(t){Util.Warn("Unbound event:",t),Util.StorageAppend(LOG_KEY,t)}),g.Connect()}/* globals AssetPaths Strings CSSCheerStyles GIT_URL CUR_URL LOG_KEY CFG_KEY *//* globals HTMLGenerator GetLayout ParseLayout FormatLayout Fanfare *//* vim: set ts=2 sts=2 sw=2 et: */