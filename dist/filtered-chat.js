/* Twitch Filtered Chat Main Module */"use strict";/* FIXME:
 * Username context window should slide rather than teleport to new names
 * Chat line backgrounds flicker unpredictably between messages
 * setModuleSettings template injection via malicious config string?
 *//* TODO (in approximate decreasing priority):
 * Add to content to both #settings help and builder links
 *   shayd3 is working on the builder
 * Create a README.md file for the plugins directory. Include documentation on:
 *   Commands
 *   Filtering
 *   Plugin configuration (?plugincfg)
 * Add configurable message highlighting (//highlight)
 * Auto-complete command arguments
 * Remove F1 hotkey binding
 *//* IDEAS:
 * Add layout selection box to #settings (reloads page on change)?
 * Allow for a configurable number of columns?
 * Add re-include (post-exclude) filtering options for Mods, Bits, Subs, etc?
 *//* Filtering out JOIN/PART or PRIVMSG logged messages
 *   Util.Logger.add_filter(/^ws recv.*\b(JOIN|PART)\b/)
 *   Util.Logger.add_filter(/^ws recv.*\bPRIVMSG\b/)
 *//* Utility functions {{{0 *//* Call func when the input element is changed */var _slicedToArray=function(){function a(a,b){var c=[],d=!0,e=!1,f=void 0;try{for(var g,h=a[Symbol.iterator]();!(d=(g=h.next()).done)&&(c.push(g.value),!(b&&c.length===b));d=!0);}catch(a){e=!0,f=a}finally{try{!d&&h["return"]&&h["return"]()}finally{if(e)throw f}}return c}return function(b,c){if(Array.isArray(b))return b;if(Symbol.iterator in Object(b))return a(b,c);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(a){return typeof a}:function(a){return a&&"function"==typeof Symbol&&a.constructor===Symbol&&a!==Symbol.prototype?"symbol":typeof a},_createClass=function(){function a(a,b){for(var c,d=0;d<b.length;d++)c=b[d],c.enumerable=c.enumerable||!1,c.configurable=!0,"value"in c&&(c.writable=!0),Object.defineProperty(a,c.key,c)}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}();function _classCallCheck(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}function onChange(a,b){var c=!0,d=!1,f=void 0;try{for(var g,h=$(a)[Symbol.iterator]();!(c=(g=h.next()).done);c=!0){var i=g.value,e=$(i);if(e.is("input")){var j=e.attr("type");"text"===j?(e.keyup(function(a){if("Enter"===a.key)return b.bind(this)(a)}),e.blur(function(a){b.bind(this)(a)})):"checkbox"===j?e.change(function(a){b.bind(this)(a)}):e.change(function(a){b.bind(this)(a)})}else e.change(function(a){b.bind(this)(a)})}}catch(a){d=!0,f=a}finally{try{!c&&h.return&&h.return()}finally{if(d)throw f}}}/* End utility functions 0}}} *//* Document writing functions {{{0 */var Content=function(){function a(){_classCallCheck(this,a)}return _createClass(a,null,[{key:"add",/* exported Content */value:function c(b){a.addHTML($("<span class=\"message\"></span>").text(b))}},{key:"addHTML",value:function f(a){var b=Math.pow,c=1<arguments.length&&void 0!==arguments[1]?arguments[1]:null,d=c?$(c):$(".module .content"),e=$("<div class=\"line line-wrapper\"></div>");"string"==typeof a?e.html(a):a instanceof Node?e.append($(a)):e.append(a),d.append(e),d.attr("data-no-scroll")||d.scrollTop(b(2,31)-1)}},{key:"addPre",value:function c(b){a.addHTML($("<div class=\"pre\"></div>").html(b))}},{key:"addInfo",value:function e(b){var c=!!(1<arguments.length&&void 0!==arguments[1])&&arguments[1],d=$("<div class=\"info\"></div>").html(b);/* does not escape */c&&d.addClass("pre"),a.addHTML(d)}},{key:"addNotice",value:function e(b){var c=!!(1<arguments.length&&void 0!==arguments[1])&&arguments[1],d=$("<div class=\"notice\"></div>").html(b);/* does not escape */c&&d.addClass("pre"),a.addHTML(d)}},{key:"addError",value:function e(b){var c=!!(1<arguments.length&&void 0!==arguments[1])&&arguments[1],d=$("<div class=\"error\"></div>").html(b);/* does not escape */c&&d.addClass("pre"),a.addHTML(d)}},{key:"addHelp",value:function c(b){a.addPre($("<div class=\"help\"></div>").html(b))}},{key:"addHelpText",value:function c(b){a.addPre($("<div class=\"help\"></div>").text(b))}},{key:"addHelpLine",value:function d(b,c){a.addPre(ChatCommands.helpLine(b,c))}}]),a}();/* End document writing functions 0}}} *//* Begin configuration section {{{0 *//* Merge the query string into the config object given and return removals */function parseQueryString(a){var b=Math.clamp,c=1<arguments.length&&void 0!==arguments[1]?arguments[1]:null,d={},e=[],f=c||window.location.search;/* Figure out what was passed *//* Generated configuration *//* List of keys to remove from window.location */"string"==typeof f?d=Util.ParseQueryString(f):"object"===("undefined"==typeof f?"undefined":_typeof(f))?d=f:Util.Error("Refusing to parse strange query string object",f);var g=!0,h=!1,i=void 0;try{for(var j,l=Object.entries(d)[Symbol.iterator]();!(g=(j=l.next()).done);g=!0){var m=j.value,n=_slicedToArray(m,2),o=n[0],k=n[1],p=o,q=k;/* config key *//* config val */if("clientid"===o)p="ClientID",a.__clientid_override=!0,e.push(o);else if("user"===o||"name"===o||"nick"===o)p="Name";else if("pass"===o||"oauth"===o)p="Pass",e.push(o);else if("channel"===o||"channels"===o)p="Channels",q=k.split(",").map(function(a){return Twitch.FormatChannel(a)});else if("debug"===o)p="Debug",q="boolean"==typeof k?k:"number"==typeof k?b(k,Util.LEVEL_MIN,Util.LEVEL_MAX):"debug"===k?Util.LEVEL_DEBUG:"trace"===k?Util.LEVEL_TRACE:!!k;else if("noassets"===o)p="NoAssets",q=!!k;else if("noffz"===o)p="NoFFZ",q=!!k;else if("nobttv"===o)p="NoBTTV",q=!!k;else if("hmax"===o)p="HistorySize","inf"===k?q=1/0:"number"==typeof k?q=k:(Util.WarnOnly("Invalid hmax value "+k+"; defaulting"),q=TwitchClient.DEFAULT_HISTORY_SIZE);else if(o.match(/^module[\d]*?$/))p="module"===o?"module1":o,q=parseModuleConfig(k);else if("trans"===o||"transparent"===o)p="Transparent",q=1;else if("layout"===o)p="Layout",q=ParseLayout(k);else if("norec"===o)p="NoAutoReconnect",q=!0;else if("size"===o)p="Size",q=k+"pt";else if("plugins"===o)p="Plugins",q=!!k;else if("disable"===o)p="DisableEffects",q=k.split(",");else if("enable"===o)p="EnableEffects",q=k.split(",");else if("max"===o)p="MaxMessages","inf"===k||-1===k?q=1/0:"number"==typeof k?q=k:(Util.WarnOnly("Invalid max value "+k+"; defaulting"),q=TwitchClient.DEFAULT_MAX_MESSAGES);else if("font"===o)p="Font",q=""+k;else if("scroll"===o)p="Scroll",q=!!k;else if("clips"===o)p="ShowClips",q=!!k;else if("plugincfg"===o){p="PluginConfig";try{q=JSON.parse(k)}catch(a){Util.Error(a),p=q=null}}else"scheme"===p?(p="ColorScheme","light"===k?q="light":"dark"===k?q="dark":(Util.WarnOnly("Invalid scheme value "+k+", defaulting to dark"),q="dark")):"noforce"===p&&(p="NoForce",q=!0);/* Skip items with a falsy key */p&&(a[p]=q)}}catch(a){h=!0,i=a}finally{try{!g&&l.return&&l.return()}finally{if(h)throw i}}return e}/* Obtain configuration key */function getConfigKey(){var a=CFG_KEY,b=Util.ParseQueryString(),c=b.config_key||b.key||b["config-key"];return c&&(a=a+"-"+c.replace(/[^a-z]/g,"")),a}/* Obtain configuration */function getConfigObject(){var a=!!(0<arguments.length&&void 0!==arguments[0])&&arguments[0],b=null,c=null,d=Util.ParseQueryString();/* 1) Obtain configuration values
   *  a) from localStorage
   *  b) from query string (overrides (a))
   *  c) from settings elements (overrides (b))
   *  d) from liveStorage (module settings only, overrides (c))
   * 2) Store module configuration in each modules' settings window
   * 3) Remove sensitive values from the query string, if present
   *//* Query String object, parsed *//* Obtain configuration from local storage */if(d.nols)Util.DisableLocalStorage(),c={};else{b=getConfigKey(),Util.SetWebStorageKey(b),b!==CFG_KEY&&Util.LogOnlyOnce("Using custom config key \""+Util.GetWebStorageKey()+"\""),c=Util.GetWebStorage()||{},c.key=b;/* Purge obsolete configuration items */var L=!1;c.hasOwnProperty("AutoReconnect")&&(delete c.AutoReconnect,L=!0),L&&Util.SetWebStorage(c)}/* Certain unwanted items may be preserved in localStorage */var f=["NoAssets","Debug","NoAutoReconnect","Layout","Transparent","Plugins","EnableEffects","DisableEffects","PluginConfig","ColorScheme","nols","NoForce"],g=!0,h=!1,i=void 0;try{for(var j,k,l=f[Symbol.iterator]();!(g=(j=l.next()).done);g=!0)k=j.value,c.hasOwnProperty(k)&&delete c[k];/* Parse the query string, storing items to remove */}catch(a){h=!0,i=a}finally{try{!g&&l.return&&l.return()}finally{if(h)throw i}}var m=parseQueryString(c,d);/* Ensure config.Channels is present for #settings configuration below */Util.IsArray(c.Channels)||(c.Channels=[]);/* Obtain global settings config */var n=$("input#txtChannel"),o=$("input#txtNick"),p=$("input#txtPass");if(n.val()){var q=!0,r=!1,s=void 0;try{for(var t,u=n.val().split(",")[Symbol.iterator]();!(q=(t=u.next()).done);q=!0){var v=t.value,w=Twitch.FormatChannel(v.toLowerCase());-1===c.Channels.indexOf(w)&&c.Channels.push(w)}}catch(a){r=!0,s=a}finally{try{!q&&u.return&&u.return()}finally{if(r)throw s}}}/* See if there's any sensitive information we need to remove */if(o.val()&&o.val()!==Strings.NAME_AUTOGEN&&(c.Name=o.val()),p.val()&&p.val()!==Strings.PASS_CACHED&&(c.Pass=p.val()),c.hasOwnProperty("Scroll")||(c.Scroll=$("#cbScroll").is(":checked")),c.hasOwnProperty("ShowClips")||(c.ShowClips=$("#cbClips").is(":checked")),c.hasOwnProperty("NoForce")||(c.NoForce=$("#cbForce").is(":checked")),$(".module").each(function(){var a=$(this).attr("id"),b=function(a){return Util.IsArray(a)?a:[]};/* Populate module configuration from liveStorage (if present) */if(c[a]||(c[a]=getModuleSettings($(this))),window.liveStorage&&window.liveStorage[a]){var d=!0,e=!1,f=void 0;try{for(var g,h=Object.entries(window.liveStorage[a])[Symbol.iterator]();!(d=(g=h.next()).done);d=!0){var i=g.value,j=_slicedToArray(i,2),l=j[0],k=j[1];c[a][l]=k}}catch(a){e=!0,f=a}finally{try{!d&&h.return&&h.return()}finally{if(e)throw f}}}/* Ensure all the settings have the proper types */c[a].Pleb=!!c[a].Pleb,c[a].Sub=!!c[a].Sub,c[a].VIP=!!c[a].VIP,c[a].Mod=!!c[a].Mod,c[a].Event=!!c[a].Event,c[a].Bits=!!c[a].Bits,c[a].Me=!!c[a].Me,c[a].IncludeKeyword=b(c[a].IncludeKeyword),c[a].IncludeUser=b(c[a].IncludeUser),c[a].ExcludeUser=b(c[a].ExcludeUser),c[a].ExcludeStartsWith=b(c[a].ExcludeStartsWith),c[a].FromChannel=b(c[a].FromChannel)}),0<m.length){Util.SetWebStorage(c);/* Obtain the current query string */var x=Util.ParseQueryString(window.location.search.substr(1)),y=!1;x.base64&&0<x.base64.length&&(y=!0,x=Util.ParseQueryString(atob(x.base64)));/* Remove the sensitive items */var z=!0,A=!1,B=void 0;try{for(var C,D,E=m[Symbol.iterator]();!(z=(C=E.next()).done);z=!0)D=C.value,delete x[D];/* Create and apply a new query string */}catch(a){A=!0,B=a}finally{try{!z&&E.return&&E.return()}finally{if(A)throw B}}var M=Util.FormatQueryString(x);y&&(M="?base64="+encodeURIComponent(btoa(M))),window.location.search=M}/* Merge in top-level liveStorage items */if(window.liveStorage){var F=!0,G=!1,H=void 0;try{for(var I,J,K=Object.keys(window.liveStorage)[Symbol.iterator]();!(F=(I=K.next()).done);F=!0)J=I.value,J.match(/^module[0-9]*$/)||c[J]===window.liveStorage[J]||(c[J]=window.liveStorage[J])}catch(a){G=!0,H=a}finally{try{!F&&K.return&&K.return()}finally{if(G)throw H}}}/* Finally, ensure certain defaults *//* Default name is no name */return"string"!=typeof c.Name&&(c.Name=""),a?"string"!=typeof c.Pass&&(c.Pass=""):c.Pass=null,c.hasOwnProperty("Plugins")||(c.Plugins=!1),c.hasOwnProperty("Debug")||(c.Debug=!1),c.hasOwnProperty("Channels")||(c.Channels=[]),c.hasOwnProperty("Layout")||(c.Layout=GetLayout()),c.hasOwnProperty("MaxMessages")||(c.MaxMessages=TwitchClient.DEFAULT_MAX_MESSAGES),c.hasOwnProperty("HistorySize")||(c.HistorySize=TwitchClient.DEFAULT_HISTORY_SIZE),a?!c.ClientID&&(c.ClientID=[19,86,67,115,22,38,198,3,55,118,67,35,150,230,71,134,83,3,119,166,86,39,38,167,135,134,147,214,38,55].map(function(a){return Util.ASCII[16*(15&a)+(240&a)/16]}).join("")):c.ClientID=null,a||(delete c.ClientID,delete c.Pass),c}/* Store configuration */function mergeConfigObject(){var a=0<arguments.length&&arguments[0]!==void 0?arguments[0]:null,b=a||{},c=getConfigObject(!0);if(Util.IsArray(b)){var d=!0,e=!1,f=void 0;try{for(var g,h=b[Symbol.iterator]();!(d=(g=h.next()).done);d=!0){var i=g.value,j=_slicedToArray(i,2),l=j[0],k=j[1];c[l]=k}}catch(a){e=!0,f=a}finally{try{!d&&h.return&&h.return()}finally{if(e)throw f}}}else{var m=!0,n=!1,o=void 0;try{for(var p,q=Object.entries(b)[Symbol.iterator]();!(m=(p=q.next()).done);m=!0){var r=p.value,s=_slicedToArray(r,2),t=s[0],u=s[1];c[t]=u}}catch(a){n=!0,o=a}finally{try{!m&&q.return&&q.return()}finally{if(n)throw o}}}Util.SetWebStorage(c),window.liveStorage=c}/* Module configuration {{{1 *//* Enumerate the active modules */function getModules(){/* exported getModules */var a={},b=!0,c=!1,d=void 0;try{for(var e,f,g=$(".module")[Symbol.iterator]();!(b=(e=g.next()).done);b=!0)f=e.value,a[$(f).attr("id")]=f}catch(a){c=!0,d=a}finally{try{!b&&g.return&&g.return()}finally{if(c)throw d}}return a}/* Apply configuration to the module's settings HTML */function setModuleSettings(a,b){function c(a,b,c){if(c&&0<c.length){var e=!0,f=!1,g=void 0;try{for(var h,i=c[Symbol.iterator]();!(e=(h=i.next()).done);e=!0){var j=h.value,k=$("<li></li>"),l="input."+CSS.escape(a)+"[value=\""+CSS.escape(j)+"\"]";if(0===d.find(l).length){var m=$("<label></label>").val(b),n=$("<input type=\"checkbox\" checked />");n.addClass(a),n.attr("value",j),n.click(updateModuleConfig),m.append(n),m.html(m.html()+b+j.escape()),k.append(m),d.find("li."+CSS.escape(a)).before(k)}}}catch(a){f=!0,g=a}finally{try{!e&&i.return&&i.return()}finally{if(f)throw g}}}}var d=$(a);b.Name&&(d.find("label.name").html(b.Name),d.find("input.name").val(b.Name)),d.find("input.pleb").check(b.Pleb),d.find("input.sub").check(b.Sub),d.find("input.vip").check(b.VIP),d.find("input.mod").check(b.Mod),d.find("input.event").check(b.Event),d.find("input.bits").check(b.Bits),d.find("input.me").check(b.Me),c("include_user","From: ",b.IncludeUser),c("include_keyword","Contains: ",b.IncludeKeyword),c("exclude_user","From: ",b.ExcludeUser),c("exclude_startswith","Starts with: ",b.ExcludeStartsWith),c("from_channel","Channel: ",b.FromChannel)}/* Obtain the settings from the module's settings HTML */function getModuleSettings(a){var b=$(a),c={Name:b.find("input.name").val(),Pleb:b.find("input.pleb").is(":checked"),Sub:b.find("input.sub").is(":checked"),VIP:b.find("input.vip").is(":checked"),Mod:b.find("input.mod").is(":checked"),Event:b.find("input.event").is(":checked"),Bits:b.find("input.bits").is(":checked"),Me:b.find("input.me").is(":checked"),IncludeUser:[],IncludeKeyword:[],ExcludeUser:[],ExcludeStartsWith:[],FromChannel:[]};return b.find("input.include_user:checked").each(function(){c.IncludeUser.push($(this).val())}),b.find("input.include_keyword:checked").each(function(){c.IncludeKeyword.push($(this).val())}),b.find("input.exclude_user:checked").each(function(){c.ExcludeUser.push($(this).val())}),b.find("input.exclude_startswith:checked").each(function(){c.ExcludeStartsWith.push($(this).val())}),b.find("input.from_channel:checked").each(function(){c.FromChannel.push($(this).val())}),c}/* Parse a module configuration object from a query string component */function parseModuleConfig(a){for(var b=function(a){return a.map(function(a){return decodeURIComponent(a)})},c=b(a.split(/,/g));7>c.length;)c.push("");/* Upgrade configuration from 6x to 7x */"111111"===c[1]&&(c[1]="1111111");var d=Util.DecodeFlags(c[1],7),e={};return e.Name=c[0],e.Pleb=d[0],e.Sub=d[1],e.VIP=d[2],e.Mod=d[3],e.Event=d[4],e.Bits=d[5],e.Me=d[6],e.IncludeKeyword=c[2]?b(c[2].split(/,/g)):[],e.IncludeUser=c[3]?b(c[3].split(/,/g)):[],e.ExcludeUser=c[4]?b(c[4].split(/,/g)):[],e.ExcludeStartsWith=c[5]?b(c[5].split(/,/g)):[],e.FromChannel=c[6]?b(c[6].split(/,/g)):[],e}/* Format the module configuration object into a query string component */function formatModuleConfig(a){var b=function(a){return a.map(function(a){return encodeURIComponent(a)})},c=[a.Pleb,a.Sub,a.VIP,a.Mod,a.Event,a.Bits,a.Me],d=[a.Name,Util.EncodeFlags(c,!1),b(a.IncludeKeyword).join(","),b(a.IncludeUser).join(","),b(a.ExcludeUser).join(","),b(a.ExcludeStartsWith).join(","),b(a.FromChannel).join(",")];return b(d).join(",")}/* Store the modules' settings in both localStorage and liveStorage */function updateModuleConfig(){var a={};$(".module").each(function(){var b=$(this).attr("id");a[b]=getModuleSettings($(this)),window.liveStorage||(window.liveStorage={}),window.liveStorage[b]=a[b]}),mergeConfigObject(a)}/* End module configuration 1}}} *//* Set the joined channels to the list given */function setChannels(a,b){var c=function(a){return Twitch.FormatChannel(Twitch.ParseChannel(a))},d=b.map(c),e=a.GetJoinedChannels().map(c),f=d.filter(function(a){return-1===e.indexOf(a)}),g=e.filter(function(a){return-1===d.indexOf(a)}),h=!0,i=!1,j=void 0;/* Join all the channels added */try{for(var k,l,m=f[Symbol.iterator]();!(h=(k=m.next()).done);h=!0)l=k.value,a.JoinChannel(l),Content.addNotice("Joining "+l);/* Leave all the channels removed */}catch(a){i=!0,j=a}finally{try{!h&&m.return&&m.return()}finally{if(i)throw j}}var n=!0,o=!1,p=void 0;try{for(var q,r,s=g[Symbol.iterator]();!(n=(q=s.next()).done);n=!0)r=q.value,a.LeaveChannel(r),Content.addNotice("Leaving "+r)}catch(a){o=!0,p=a}finally{try{!n&&s.return&&s.return()}finally{if(o)throw p}}}/* End configuration section 0}}} *//* Return whether or not the event should be filtered */function shouldFilter(a,b){var c=getModuleSettings(a);if(window.Plugins&&!window.PluginsAreDisabled){var u=Plugins.invoke("shouldFilter",a,b);if(u&&0<u.length){var d=!0,e=!1,f=void 0;try{for(var g,h,j=u[Symbol.iterator]();!(d=(g=j.next()).done);d=!0)if(h=g.value,"boolean"==typeof h)return h;/* Other values: continue the filtering logic */}catch(a){e=!0,f=a}finally{try{!d&&j.return&&j.return()}finally{if(e)throw f}}}}if(b instanceof TwitchChatEvent){var k=b.user||"",l=b.message?b.message.toLowerCase():"",m="pleb";/* NOTE: pleb < sub < vip < mod *//* Includes take priority over excludes */if(b.issub&&(m="sub"),b.isvip&&(m="vip"),b.ismod&&(m="mod"),c.IncludeUser.any(function(a){return a.equalsLowerCase(k)}))return!1;if(c.IncludeKeyword.any(function(a){return-1<l.indexOf(a)}))return!1;/* Role filtering */if(!c.Pleb&&"pleb"==m)return!0;if(!c.Sub&&"sub"==m)return!0;if(!c.VIP&&"vip"==m)return!0;if(!c.Mod&&"mod"==m)return!0;/* Content filtering ("Bits" also filters out cheer effects) */if(!c.Bits&&b.flags.bits)return!0;if(!c.Me&&b.flags.action)return!0;/* Exclude filtering */if(c.ExcludeUser.any(function(a){return a.equalsLowerCase(k)}))return!0;if(c.ExcludeStartsWith.any(function(a){return l.startsWith(a)}))return!0;/* Filtering to permitted channels (default: permit all) */if(0<c.FromChannel.length){var n=!0,o=!1,p=void 0;try{for(var q,r,t=c.FromChannel[Symbol.iterator]();!(n=(q=t.next()).done);n=!0)if(r=q.value,b.channelString.equalsLowerCase(r))return!0}catch(a){o=!0,p=a}finally{try{!n&&t.return&&t.return()}finally{if(o)throw p}}return!1}}else if(b instanceof TwitchEvent&&!c.Event&&("USERNOTICE"===b.command||"NOTICE"===b.command))/* Filter out events and notices */return!0;return!1}/* Populate and show the username context window */function showUserContextWindow(a,b,c){var f=Math.round,g=Number.parseInt;/* Define functions for building elements */function d(a){var b=$("<div class=\"item\"></div>");return"string"==typeof a?b.html(a):b.append(a),b}function e(a,b){var c=$("<a class=\"cw-link\"></a>");return c.attr("id",a),c.text(b),c}var i=$(b),j=$(c),k=j.attr("data-id"),m=j.attr("data-user"),n=j.find(".username").text(),o=j.attr("data-user-id"),p="#"+j.attr("data-channel"),q=j.attr("data-channelid"),r="1"===j.attr("data-subscriber"),s="1"===j.attr("data-mod"),u="1"===j.attr("data-vip"),v="1"===j.attr("data-caster"),x=g(j.attr("data-sent-ts")),y=new Date(x);/* Attributes of the host line */i.html(""),i.attr("data-id",k),i.attr("data-user",m),i.attr("data-user-id",o),i.attr("data-channel",p),i.attr("data-chid",q),i.attr("data-sub",r),i.attr("data-mod",s),i.attr("data-vip",u),i.attr("data-caster",v),i.attr("data-id",k);var z=function(a){return $("<span class=\"em pad\"></span>").html(a)},A=j.find(".username"),B=A.attr("class").escape(),C=A.attr("style").escape();/* Add user's display name *//* Add link to timeout user */if(i.append(d("<span class=\""+B+"\" style=\""+C+"\">"+n+"</span>"+" in <span class=\"em\">"+p+"</span>")),a.IsMod(p)){var D=$("<div class=\"cw-timeout\">Timeout:</div>"),E=!0,F=!1,G=void 0;try{for(var H,I=["1s","10s","60s","10m","30m","1h","12h","24h"][Symbol.iterator]();!(E=(H=I.next()).done);E=!0){var J=H.value,K=e("cw-timeout-"+m+"-"+J,J);K.addClass("cw-timeout-dur"),K.attr("data-channel",p),K.attr("data-user",m),K.attr("data-duration",J),K.click(function(){var c=$(this).attr("data-channel"),e=$(this).attr("data-user"),f=$(this).attr("data-duration");a.Timeout(c,e,f),Util.Log("Timed out user "+e+" from "+c+" for "+f),$(b).fadeOut()}),D.append(K)}}catch(a){F=!0,G=a}finally{try{!E&&I.return&&I.return()}finally{if(F)throw G}}i.append(D)}/* Add link which places "/ban <user>" into the chat textbox */if(a.IsMod(p)){var X=e("cw-ban-"+m,"Ban");X.addClass("cw-ban-user"),X.attr("data-channel",p),X.attr("data-user",m),X.click(function(){$("#txtChat").val("/ban "+$(this).attr("data-user"))}),i.append(X)}/* Add other information */var L=Util.FormatDate(y),M=Util.FormatInterval((Date.now()-x)/1e3);/* Add roles (and ability to remove roles, for the caster) */if(i.append(d("Sent: "+L+" ("+M+" ago)")),i.append(d("UserID: "+o)),i.append(d("MsgUID: "+k)),s||u||r||v){var N=d("User Role: "),O=[];if(s&&O.push(z("Mod")),u&&O.push(z("VIP")),r&&O.push(z("Sub")),v&&O.push(z("Host")),0<O.length){N.append(O[0]);var P=!0,Q=!1,R=void 0;try{for(var S,T,U=O.slice(1)[Symbol.iterator]();!(P=(S=U.next()).done);P=!0)T=S.value,N.append(", "),N.append(T)}catch(a){Q=!0,R=a}finally{try{!P&&U.return&&U.return()}finally{if(Q)throw R}}i.append(N)}a.IsCaster(p)&&!a.IsUIDSelf(o)&&(s&&i.append(d(e("cw-unmod","Remove Mod"))),u&&i.append(d(e("cw-unvip","Remove VIP"))))}/* Add the ability to add roles (for the caster) */a.IsCaster(p)&&!a.IsUIDSelf(o)&&(!s&&i.append(d(e("cw-make-mod","Make Mod"))),!u&&i.append(d(e("cw-make-vip","Make VIP")))),Util.Trace("Showing ucw for",j);var V=j.offset(),W=f(V.top)+j.outerHeight()+2,t=f(V.left),l=i.outerWidth(),w=i.outerHeight(),h={top:W,left:t,width:l,height:w};Util.ClampToScreen(h),delete h.width,delete h.height,i.fadeIn().offset(h)}/* Set or unset transparency */function updateTransparency(a){/* exported updateTransparency */var b=[];try{var c=Util.CSS.GetSheet("main.css"),d=Util.CSS.GetRule(c,":root"),e=!0,f=!1,g=void 0;/* Find the prop="--<name>-color" rules */try{for(var h,i,j=Util.CSS.GetPropertyNames(d)[Symbol.iterator]();!(e=(h=j.next()).done);e=!0)i=h.value,i.match(/^--[a-z-]+-color$/)&&b.push(i)}catch(a){f=!0,g=a}finally{try{!e&&j.return&&j.return()}finally{if(f)throw g}}}catch(a){/* Unable to enumerate properties; use hard-coded ones */Util.ErrorOnce("Failed getting main.css :root",a),b=["--body-color","--header-color","--menudiv-color","--module-color","--odd-line-color","--sub-color","--chat-color","--textarea-color"]}var k=!0,l=!1,m=void 0;try{for(var n,o,p=b[Symbol.iterator]();!(k=(n=p.next()).done);k=!0)o=n.value,a?(Util.CSS.SetProperty(o,"transparent"),$(".module").addClass("transparent"),$("body").addClass("transparent")):(Util.CSS.SetProperty(o,"var("+o+"-default)"),$(".module").removeClass("transparent"),$("body").removeClass("transparent"))}catch(a){l=!0,m=a}finally{try{!k&&p.return&&p.return()}finally{if(l)throw m}}}/* Set the colorscheme to dark */function setDarkScheme(){/* exported setDarkScheme */$("body").removeClass("light").addClass("dark"),$("#btnSettings").attr("src",AssetPaths.SETTINGS)}/* Set the colorscheme to light */function setLightScheme(){/* exported setLightScheme */$("body").removeClass("dark").addClass("light"),$("#btnSettings").attr("src",AssetPaths.SETTINGS_LIGHT)}/* Set or clear window notification badge */function setNotify(){var a=!(0<arguments.length&&arguments[0]!==void 0)||arguments[0],b=a?AssetPaths.FAVICON_ALERT:AssetPaths.FAVICON;/* exported setNotify */$("link[rel=\"shortcut icon\"]").attr("href",b)}/* Called once when the document loads */function doLoadClient(){var m=Number.parseInt,n=Math.clamp;/* Function for syncing configuration with HTMLGen */function a(){var a=!0,b=!1,c=void 0;try{for(var d,e=Object.entries(getConfigObject())[Symbol.iterator]();!(a=(d=e.next()).done);a=!0){var f=d.value,g=_slicedToArray(f,2),h=g[0],i=g[1];o.get("HTMLGen").setValue(h,i)}}catch(a){b=!0,c=a}finally{try{!a&&e.return&&e.return()}finally{if(b)throw c}}}/* Construct the plugins *//* Close the main settings window */function b(){updateModuleConfig(),$("#settings").fadeOut()}/* Open the main settings window */function c(){var a=getConfigObject(!0);$("#txtChannel").val(a.Channels.join(",")),$("#txtNick").val(a.Name||Strings.NAME_AUTOGEN),a.Pass&&0<a.Pass.length&&($("#txtPass").attr("disabled","disabled").hide(),$("#txtPassDummy").show()),$("#selDebug").val(""+a.Debug),$("#settings").fadeIn()}/* Toggle the main settings window */function d(){$("#settings").is(":visible")?b():c()}/* Close a module's settings window */function f(a){updateModuleConfig();var b=$(a).find(".settings"),c=b.siblings("input.name"),d=b.siblings("label.name");c.hide(),d.html(c.val()).show(),b.fadeOut()}/* Open a module's settings window */function g(a){var b=$(a).find(".settings"),c=b.siblings("input.name"),d=b.siblings("label.name");d.hide(),c.val(d.html()).show(),b.fadeIn()}/* Toggle a module's settings window */function h(a){var b=$(a).find(".settings");b.is(":visible")?f(a):g(a)}/* Reset chat auto-completion variables */function j(){var a=$("#txtChat");a.attr("data-complete-text",""),a.attr("data-complete-pos","-1"),a.attr("data-complete-index","0")}/* Reset chat history recall */function k(){$("#txtChat").attr("data-hist-index","-1")}/* Initialize chat auto-completion and history *//* Open the settings builder page */function l(){Util.Open(AssetPaths.BUILDER_WINDOW,"_blank",{})}/* Add command to open the settings builder page *//* exported doLoadClient */var o=void 0,p={};/* Hook Logger messages *//* Disable configured events */if(Util.Logger.add_hook(function(){if(Util.DebugLevel>=Util.LEVEL_DEBUG){for(var a,b=arguments.length,c=Array(2<b?b-2:0),d=2;d<b;d++)c[d-2]=arguments[d];var e=(a=Util.Logger).stringify.apply(a,c);Content.addError("ERROR: "+e.escape())}},"ERROR"),Util.Logger.add_hook(function(){for(var a,b=arguments.length,c=Array(2<b?b-2:0),d=2;d<b;d++)c[d-2]=arguments[d];var e=(a=Util.Logger).stringify.apply(a,c);1===c.length&&c[0]instanceof TwitchEvent?Util.DebugLevel>=Util.LEVEL_TRACE&&Content.addNotice("WARNING: "+JSON.stringify(c[0])):Util.DebugLevel>=Util.LEVEL_DEBUG&&Content.addNotice("WARNING: "+e.escape())},"WARN"),Util.Logger.add_hook(function(){if(Util.DebugLevel>=Util.LEVEL_TRACE){for(var a,b=arguments.length,c=Array(2<b?b-2:0),d=2;d<b;d++)c[d-2]=arguments[d];var e=(a=Util.Logger).stringify.apply(a,c);Content.addHTML("DEBUG: "+e.escape())}},"DEBUG"),Util.Logger.add_hook(function(){if(Util.DebugLevel>=Util.LEVEL_TRACE){for(var a,b=arguments.length,c=Array(2<b?b-2:0),d=2;d<b;d++)c[d-2]=arguments[d];var e=(a=Util.Logger).stringify.apply(a,c);Content.addHTML("TRACE: "+e.escape())}},"TRACE"),ChatCommands.add("config",function(a,b){var c=Number.parseFloat,d=getConfigObject(!0),e=0<b.length?b[0]:"";if(0===b.length){var aa=[];Content.addHelp("<em>Global Configuration Values:</em>");var f=!0,g=!1,h=void 0;try{for(var i,j=Object.entries(d)[Symbol.iterator]();!(f=(i=j.next()).done);f=!0){var l=i.value,n=_slicedToArray(l,2),o=n[0],k=n[1],p=o,q=""+k;"Layout"===o?q=FormatLayout(k):"ClientID"===o?q="Omitted for security; use //config clientid to show":"Pass"===o?q="Omitted for security; use //config pass to show":"object"===("undefined"==typeof k?"undefined":_typeof(k))&&k.Name&&0<k.Name.length&&(p=null,q=null,aa.push([o,k])),null!==p&&Content.addHelpLine(p,q)}}catch(a){g=!0,h=a}finally{try{!f&&j.return&&j.return()}finally{if(g)throw h}}Content.addHelp("<em>Window Configuration Values:</em>");var r=!0,s=!1,t=void 0;try{for(var u,v=aa[Symbol.iterator]();!(r=(u=v.next()).done);r=!0){var w=u.value,x=_slicedToArray(w,2),y=x[0],z=x[1],A=function(a){return"&quot;"+a+"&quot"},B="&quot;"+z.Name+"&quot;";Content.addHelp("Module "+("<span class=\"arg\">"+y+"</span>")+": "+B);var C=!0,D=!1,E=void 0;try{for(var F,G=Object.entries(z)[Symbol.iterator]();!(C=(F=G.next()).done);C=!0){var H=F.value,I=_slicedToArray(H,2),J=I[0],K=I[1];"Name"!==J&&Content.addHelpLine(J,A(K))}}catch(a){D=!0,E=a}finally{try{!C&&G.return&&G.return()}finally{if(D)throw E}}}}catch(a){s=!0,t=a}finally{try{!r&&v.return&&v.return()}finally{if(s)throw t}}}else if("help"===e)Content.addHelpLine("//config","Show and manipulate configuration"),Content.addHelpText("//config parameters:"),Content.addHelpLine("export","Export *all* of localStorage to a new tab (contains secrets!)"),Content.addHelpLine("purge","Clear localStorage (cannot be undone!)"),Content.addHelpLine("clientid","Display ClientID"),Content.addHelpLine("pass","Dislay OAuth token (if one is present)"),Content.addHelpLine("url","Generate a URL from the current configuration"),Content.addHelpText("//config url parameters (can be used in any order):"),Content.addHelpLine("git","Force URL to target github.io"),Content.addHelpLine("text","Force URL to be un-encoded"),Content.addHelpLine("auth","Include secrets in URL"),Content.addHelpText("//config set <key> <value>: Change <key> to <value> (dangerous!)"),Content.addHelpText("//config setobj <key> <value>: Change <key> to JSON-encoded <value> (dangerous!)"),Content.addHelpText("//config unset <key>: Remove <key> (dangerous!)");else if("export"===e)Util.Open(AssetPaths.CONFIG_EXPORT_WINDOW,"_blank",{});else if("purge"===e)Util.SetWebStorage({}),window.liveStorage={},Content.addNotice("Purged storage \""+Util.GetWebStorageKey()+"\"");else if("clientid"===e)Content.addHelpLine("ClientID",d.ClientID);else if("pass"===e)Content.addHelpLine("Pass",d.Pass);else if("url"===e){/* Generate a URL with the current configuration, omitting items
       * left at default values *//* Base URL, query string array, and function to add items */var L=-1<b.indexOf("git")?GIT_URL:CUR_URL,M=[],N=function(a,b){return M.push(a+"="+encodeURIComponent(b))};0<d.Debug&&N("debug",d.Debug),d.__clientid_override&&N("clientid",d.ClientID),N("channels",d.Channels.join(",")),d.NoAssets&&N("noassets",d.NoAssets),d.NoFFZ&&N("noffz",d.NoFFZ),d.NoBTTV&&N("nobttv",d.NoBTTV),d.HistorySize&&N("hmax",d.HistorySize);var O=!0,P=!1,Q=void 0;try{for(var R,S,T=Object.keys(getModules())[Symbol.iterator]();!(O=(R=T.next()).done);O=!0)S=R.value,N(S,formatModuleConfig(d[S]))}catch(a){P=!0,Q=a}finally{try{!O&&T.return&&T.return()}finally{if(P)throw Q}}N("layout",FormatLayout(d.Layout)),d.Transparent&&N("trans","1"),d.NoAutoReconnect&&N("norec","1");var U=Util.CSS.GetProperty("--body-font-size"),V=Util.CSS.GetProperty("--body-font-size-default");U!==V&&N("size",U.replace(/[^0-9]/g,"")),d.Plugins&&N("plugins","1"),d.MaxMessages!==TwitchClient.DEFAULT_MAX_MESSAGES&&N("max",""+d.MaxMessages),d.Font&&N("font",d.Font),d.Scroll&&N("scroll","1"),d.ShowClips&&N("clips","1"),-1<b.indexOf("auth")&&(N("user",d.Name),N("pass",d.Pass)),d.DisableEffects&&N("disable",d.DisableEffects.join(",")),d.EnableEffects&&N("enable",d.EnableEffects.join(",")),d.PluginConfig&&N("plugincfg",JSON.stringify(d.PluginConfig)),"dark"===d.ColorScheme?N("scheme","dark"):"light"===d.ColorScheme&&N("scheme","light"),d.tag&&N("tag",d.tag),d.NoForce&&N("noforce","1"),L+="text"===b[b.length-1]?"?"+M.join("&"):"?base64="+encodeURIComponent(btoa(M.join("&"))),Content.addHelp($("<a></a>").attr("href",L).text(L))}else if(("set"===e||"setobj"===e)&&2<b.length){/* Allow changing configuration by command (dangerous) */var W=b[1],X=b.slice(2).join(" "),Y=null;Y="setobj"===e?JSON.parse(X):"true"===X||"false"!==X&&("Infinity"===X?1/0:"-Infinity"===X?-Infinity:"NaN"===X?NaN:X.match(/^[+-]?(?:\d|[1-9]\d*)$/)?m(X):X.match(/^[-+]?(?:\d*\.\d+|\d+)$/)?c(X):X);var ba=JSON.stringify(Y);if(Util.ObjectHas(d,W)){var Z=Util.ObjectGet(d,W),_=JSON.stringify(Z);Content.addHelpText("Changing "+W+" from \""+_+"\" to \""+ba+"\""),Content.addHelpLine(W,_),Content.addHelpLine(W,ba),Util.ObjectSet(d,W,Y),mergeConfigObject(d)}else Content.addHelpText("Adding key "+W+" with value \""+ba+"\""),Content.addHelpLine(W,ba),Util.ObjectSet(d,W,Y),mergeConfigObject(d)}else if("unset"===e&&1<b.length){var ca=b[1];Util.ObjectRemove(d,ca)?(Content.addHelpText("Removed key "+ca+" from localStorage"),Util.SetWebStorage(d)):Content.addHelpText("Failed to remove key "+ca+" from localStorage"),window.liveStorage&&(Util.ObjectRemove(window.liveStorage,ca)?Content.addHelpText("Removed key "+ca+" from liveStorage"):Content.addHelpText("Failed to removed key "+ca+" from liveStorage"))}else if(Util.ObjectHas(d,e))Content.addHelpText("Configuration:"),Content.addHelpLine(e,JSON.stringify(Util.ObjectGet(d,e)));else{var da=("\""+e+"\"").escape();Content.addError("Unknown config command or key "+da,!0)}},"Obtain and modify configuration information"),function(){var a=getConfigObject(!0);o=new TwitchClient(a),Util.DebugLevel=a.Debug,document.title+=" -",a.Pass&&0<a.Pass.length?document.title+=" Authenticated":(document.title+=" Read-Only",a.Layout.Chat&&($("#txtChat").attr("placeholder","Authentication needed to send messages"),Util.CSS.SetProperty("--chat-border","#cd143c"))),p=getConfigObject(),p.Plugins=!!a.Plugins,p.Pass=p.ClientID=null,delete p.Pass,delete p.ClientID}(),$(".module").each(function(){setModuleSettings(this,p[$(this).attr("id")])}),p.DisableEffects){var q=!0,r=!1,s=void 0;try{for(var t,u,v=p.EnableEffects[Symbol.iterator]();!(q=(t=v.next()).done);q=!0)u=t.value,CSSCheerStyles[u]&&(CSSCheerStyles[u]._disabled=!0)}catch(a){r=!0,s=a}finally{try{!q&&v.return&&v.return()}finally{if(r)throw s}}}/* Enable configured effects */if(p.EnableEffects){var w=!0,x=!1,y=void 0;try{for(var z,A,B=p.EnableEffects[Symbol.iterator]();!(w=(z=B.next()).done);w=!0)A=z.value,CSSCheerStyles[A]&&(CSSCheerStyles[A]._disabled=!1)}catch(a){x=!0,y=a}finally{try{!w&&B.return&&B.return()}finally{if(x)throw y}}}/* Simulate clicking cbTransparent if config.Transparent is set */p.Transparent?(updateTransparency(!0),$("#cbTransparent").check()):$("#cbTransparent").uncheck(),p.Size&&Util.CSS.SetProperty("--body-font-size",p.Size),p.Font&&Util.CSS.SetProperty("--body-font",p.Font),p.Scroll?($(".module .content").css("overflow-y","scroll"),$("#cbScroll").check()):$("#cbScroll").uncheck(),0===p.Channels.length&&$("#settings").fadeIn(),p.ShowClips?$("#cbClips").check():$("#cbClips").uncheck(),p.NoForce?$("#cbForce").check():$("#cbForce").uncheck(),"dark"===p.ColorScheme?setDarkScheme():"light"===p.ColorScheme&&setLightScheme(),p.NoAnim?$("#cbAnimCheers").uncheck():$("#cbAnimCheers").check(),$("#txtBGStyle").val(""),p.Font?$("#txtFont").val(p.Font):$("#txtFont").val(Util.CSS.GetProperty("--body-font")),p.Size?$("#txtFontSize").val(p.Size):$("#txtFontSize").val(Util.CSS.GetProperty("--body-font-size")),p.tag&&$("#txtTag").val(p.tag),o.set("HTMLGen",new HTMLGenerator(o,p)),p.Plugins?Plugins.loadAll(o,p):Plugins.disable(),Util.DebugLevel>=Util.LEVEL_DEBUG&&(window.client=o),ChatCommands.addHelp("Moderator commands:",{literal:!0}),ChatCommands.addHelp("!tfc reload: Reload the page",{literal:!0,command:!0}),ChatCommands.addHelp("!tfc force-reload: Reload the page, discarding cache",{literal:!0,command:!0}),ChatCommands.addHelp("!tfc nuke: Clear the chat",{literal:!0,command:!0}),ChatCommands.addHelp("!tfc nuke <user>: Clear messages sent by <user>",{command:!0,args:!0}),j(),k(),ChatCommands.add("builder",function(){Util.Open(AssetPaths.BUILDER_WINDOW,"_blank",{})},"Open the configuration builder wizard"),$("#txtChat").keydown(function(a){var b=Number.isNaN,c=event.target;if("Enter"===a.key)return 0<c.value.trim().length&&(ChatCommands.isCommandStr(c.value)?ChatCommands.execute(c.value,o):o.SendMessageToAll(c.value),o.AddHistory(c.value),c.value="",j(),k()),a.preventDefault(),!1;if("Tab"===a.key){/* TODO: Complete command arguments and @user names */var e=c.getAttribute("data-complete-text")||c.value,f=m(c.getAttribute("data-complete-pos")),g=m(c.getAttribute("data-complete-index"));(b(f)||-1===f)&&(f=c.selectionStart),b(g)&&(g=0);var d={orig_text:e,orig_pos:f,curr_text:c.value,curr_pos:c.selectionStart,index:g};return d=ChatCommands.complete(o,d),c.setAttribute("data-complete-text",d.orig_text),c.setAttribute("data-complete-pos",d.orig_pos),c.setAttribute("data-complete-index",d.index),c.value=d.curr_text,requestAnimationFrame(function(){c.selectionStart=d.curr_pos,c.selectionEnd=d.curr_pos}),k(),a.preventDefault(),!1}if("ArrowUp"===a.key||"ArrowDown"===a.key){/* Handle traversing message history */var h=m($(this).attr("data-hist-index")),l="ArrowUp"===a.key?1:-1;h=n(h+l,-1,o.GetHistoryLength()-1);var p=o.GetHistoryItem(h);null!==p&&(c.value=p.trim()),c.setAttribute("data-hist-index",""+h),requestAnimationFrame(function(){c.selectionStart=c.value.length,c.selectionEnd=c.value.length}),j()}else j(),k()}),$("#settings").keyup(function(a){"Enter"===a.key&&d()}),$("#btnSettings").click(function(){d()}),$("#btnSettingsHelp").click(function(){Util.Open(AssetPaths.HELP_WINDOW,"_blank",{})}),$("#btnSettingsBuilder").click(function(){Util.Open(AssetPaths.BUILDER_WINDOW,"_blank",{})}),onChange($("#txtChannel"),function(){setChannels(o,$(this).val().split(",")),mergeConfigObject({Channels:o.GetJoinedChannels()})}),$("#cbScroll").change(function(){var a=$(this).is(":checked");mergeConfigObject({Scroll:a}),$(".module .content").css("overflow-y",a?"scroll":"hidden")}),$("#cbTransparent").change(function(){var b=$(this).is(":checked");updateTransparency(b),a()}),$("#cbClips").change(function(){mergeConfigObject({ShowClips:$(this).is(":checked")}),a()}),$("#cbForce").change(function(){mergeConfigObject({NoForce:$(this).is(":checked")}),a()}),$("#selDebug").change(function(){var a=parseInt($(this).val());Util.Log("Changing debug level from "+Util.DebugLevel+" to "+a),Util.DebugLevel=a}),$("#btnReconnect").click(function(){o.Connect()}),$("#btnAdvanced, #btnAdvHide").click(function(){$("#advSettings").slideToggle()}),$("#cbAnimCheers").change(function(){mergeConfigObject({NoAnim:!$(this).is(":checked")}),a()}),onChange($("#txtBGStyle"),function(){$(".module").css("background-image",$(this).val())}),onChange($("#txtFont"),function(){var a=$(this).val();a&&("default"===a?Util.CSS.SetProperty("--body-font","var(--body-font-default)"):Util.CSS.SetProperty("--body-font",a))}),onChange($("#txtFontSize"),function(){var a=$(this).val();a&&("default"===a?Util.CSS.SetProperty("--body-font-size","var(--body-font-size-default)"):Util.CSS.SetProperty("--body-font-size",a))}),onChange($("#txtTag"),function(){mergeConfigObject({tag:$(this).val()})}),$(".module .header input.name").keyup(function(a){var b=$(this).parentsUntil(".column").last();"Enter"===a.key?f(b):"Escape"===a.key&&(b.find("input.name").val(b.find("label.name").html()),f(b))}),$(".module .header .clear-link").click(function(){$(this).parentsUntil(".column").find(".line-wrapper").remove()}),$(".module .settings input[type=\"text\"]").keyup(function(a){if("Enter"===a.key){var h=$(this).val();if(0<h.length){var b=$(this).closest("li"),c=b.attr("class").replace("textbox","").trim(),d=o.get("HTMLGen").checkbox(h,null,c,!0),e=b.find("label").html(),g=$("<li><label>"+d+e+" "+h+"</label></li>");b.before(g),$(this).val(""),updateModuleConfig()}}else"Escape"===a.key&&f($(this).parentsUntil(".column").last())}),$(document).keyup(function(a){if("ScrollLock"===a.key){/* ScrollLock: pause or resume auto-scroll */var b=$(".module .content"),c=b.attr("data-no-scroll");c?(b.removeAttr("data-no-scroll"),Util.Log("Auto-scroll enabled"),Content.addHelpText("Auto-scroll enabled")):(b.attr("data-no-scroll","1"),Util.Log("Auto-scroll disabled"),Content.addHelpText("Auto-scroll disabled"))}else if("Escape"===a.key){$("#settings").is(":visible")&&$("#settings").fadeOut();var d=!0,e=!1,g=void 0;try{for(var h,i,j=Object.values(getModules())[Symbol.iterator]();!(d=(h=j.next()).done);d=!0)i=h.value,$(i).find(".settings").is(":visible")&&f($(i))}catch(a){e=!0,g=a}finally{try{!d&&j.return&&j.return()}finally{if(e)throw g}}}else"F1"===a.key&&/* F1: open configuration help window */l();/* else if (!e.key.match(/^[A-Za-z0-9_]$/)) {
      if (["Shift", "Control", "Alt", "Tab"].indexOf(e.key) === -1) {
        Util.LogOnly(e.key);
        Util.DebugOnly(e);
      }
    }*/}),$(document).click(function(a){var c=$(a.target),d=!0,e=!1,g=void 0;/* Clicking on or off of the module settings button or box */try{for(var i,j=Object.values(getModules())[Symbol.iterator]();!(d=(i=j.next()).done);d=!0){var k=i.value,l=$(k),m=l.find(".menu"),n=l.find(".header"),p=l.find(".settings");Util.PointIsOn(a.clientX,a.clientY,m)?h(l):p.is(":visible")&&!Util.PointIsOn(a.clientX,a.clientY,p)&&!Util.PointIsOn(a.clientX,a.clientY,n)&&f(l)}/* Clicking off the main settings window */}catch(a){e=!0,g=a}finally{try{!d&&j.return&&j.return()}finally{if(e)throw g}}var q=$("#settings");q.is(":visible")&&!Util.PointIsOn(a.clientX,a.clientY,q)&&b();/* Clicking on the username context window */var r=$("#userContext");if(Util.PointIsOn(a.clientX,a.clientY,r)){var s=r.attr("data-channel"),t=r.attr("data-user"),u=r.attr("data-user-id");o.IsUIDSelf(u)||("cw-unmod"===c.attr("id")?(Util.Log("Unmodding "+t+" in "+s),o.SendMessage(s,"/unmod "+t)):"cw-unvip"===c.attr("id")?(Util.Log("Removing VIP for "+t+" in "+s),o.SendMessage(s,"/unvip "+t)):"cw-make-mod"===c.attr("id")?(Util.Log("Modding "+t+" in "+s),o.SendMessage(s,"/mod "+t)):"cw-make-vip"===c.attr("id")&&(Util.Log("VIPing "+t+" in "+s),o.SendMessage(s,"/vip "+t)))}else if("1"===c.attr("data-username")){/* Clicked on a username; show context window */var v=c.parent();r.is(":visible")?r.attr("data-user-id")===v.attr("data-user-id")?r.fadeOut():showUserContextWindow(o,r,v):showUserContextWindow(o,r,v)}else r.is(":visible")&&/* Clicked somewhere else: close context window */r.fadeOut();/* Clicking on a "Reconnect" link */"1"===c.attr("data-reconnect")&&(Content.addNotice("Reconnecting..."),o.Connect())}/* Clicking on an emote
    if ($t.attr("data-is-emote") === "1") {
      Util.LogOnly(`Clicked on an emote: ${$t.parent().html()}`);
    }
    */),o.bind("twitch-open",function(){$(".loading").remove(),$("#debug").hide(),Util.DebugLevel>=Util.LEVEL_DEBUG&&(o.IsAuthed()?Content.addInfo("Connected (authenticated)"):Content.addInfo("Connected (unauthenticated)")),0===getConfigObject().Channels.length&&Content.addInfo("No channels configured; type //join <channel> to join one!".escape())}),o.bind("twitch-close",function(a){var b=a.object.event.code,c=a.object.event.reason,d="(code "+b+" "+Util.WSStatus[b]+")";c&&(d="(code "+b+" "+Util.WSStatus[b]+": "+c+")"),getConfigObject().NoAutoReconnect?Content.addError("Connection closed "+d+" "+Strings.RECONNECT):(Content.addError("Connection closed "+d),!o.connecting&&o.Connect())}),o.bind("twitch-joined",function(a){var b=getConfigObject().Layout;b.Slim||Content.addInfo("Joined "+Twitch.FormatChannel(a.channel))}),o.bind("twitch-parted",function(a){var b=getConfigObject().Layout;b.Slim||Content.addInfo("Left "+Twitch.FormatChannel(a.channel))}),o.bind("twitch-notice",function(a){var b=Twitch.FormatChannel(a.channel),c=a.message.escape();Content.addNotice(b+": "+c),"cmds_available"===a.noticeMsgId&&Content.addInfo("Use //help to see Twitch Filtered Chat commands")}),o.bind("twitch-error",function(a){Util.Error(a);var b=a.user,c=a.values.command,d=a.message.escape();Content.addError("Error for "+b+": "+c+": "+d)}),o.bind("twitch-message",function(a){Util.DebugLevel>=Util.LEVEL_TRACE&&(a instanceof TwitchEvent?Content.addPre(a.repr()):Content.addPre(JSON.stringify(a)));/* Avoid flooding the DOM with stale chat messages */var b=getConfigObject().MaxMessages,d=!0,e=!1,f=void 0;/* FIXME: Causes flickering for some reason */try{for(var g,h,i=$(".content")[Symbol.iterator]();!(d=(g=i.next()).done);d=!0)for(h=g.value;$(h).find(".line-wrapper").length>b;)$(h).find(".line-wrapper").first().remove()}catch(a){e=!0,f=a}finally{try{!d&&i.return&&i.return()}finally{if(e)throw f}}}),o.bind("twitch-streaminfo",function(a){var b=getConfigObject().Layout,c=o.GetChannelInfo(a.channelString)||{};if(b&&!b.Slim)if(c.online)try{var d=c.stream.channel.url,e=c.stream.channel.display_name,f=c.stream.game,g=c.stream.viewers;Content.addNotice(Strings.StreamInfo(d,e,f,g)),c.stream.channel.status&&Content.addNotice(c.stream.channel.status)}catch(b){Util.ErrorOnly("Failed to obtain stream information:",c),Util.Error(b),Content.addNotice(Strings.StreamOnline(a.channelString))}else Content.addNotice(Strings.StreamOffline(a.channelString))}),o.bind("twitch-chat",function(a){if(a instanceof TwitchChatEvent){var b="string"==typeof a.message?a.message:"";if(a.flags&&a.flags.mod&&-1<b.indexOf(" ")){var c=b.split(" ");if("!tfc"===c[0]){if("reload"===c[1])location.reload();else if("force-reload"===c[1])location.reload(!0);else if("clear"===c[1])$(".content").children().remove();else if("nuke"===c[1])if(c[2]&&1<c[2].length){var d=CSS.escape(c[2].toLowerCase());$("[data-user=\""+d+"\"]").parent().remove()}else $(".content").children().remove();return}}}$(".module").each(function(){var b=o.get("HTMLGen");if(!shouldFilter($(this),a)){var c=$(this).find(".content"),d=$("<div class=\"line line-wrapper\"></div>"),e=b.gen(a),f=e.find(".message[data-clip]");if(0<f.length){var g=f.attr("data-clip");o.GetClip(g).then(function(a){o.GetGame(a.game_id).then(function(d){Content.addHTML(b.genClip(g,a,d),c)})})}d.append(e),Content.addHTML(d,c)}})}),o.bind("twitch-clearchat",function(a){if(a.flags["target-user-id"]){/* Moderator timed out a user */var b=CSS.escape(a.flags["room-id"]),c=CSS.escape(a.flags["target-user-id"]),d=$(".chat-line[data-channel-id=\""+b+"\"][data-user-id=\""+c+"\"]");d.parent().remove()}else/* Moderator cleared the chat */$("div.content").find(".line-wrapper").remove()}),o.bind("twitch-clearmsg",function(a){Util.StorageAppend(LOG_KEY,a),Util.Warn("Unhandled CLEARMSG:",a)}),o.bind("twitch-sub",function(a){Util.StorageAppend(LOG_KEY,a),Content.addHTML(o.get("HTMLGen").sub(a))}),o.bind("twitch-resub",function(a){/* Display the resub message, if one is present */if(Util.StorageAppend(LOG_KEY,a),Content.addHTML(o.get("HTMLGen").resub(a)),a.message){var b=o.get("HTMLGen").gen(a);b.addClass("message"),b.addClass("sub-message"),b.addClass("sub-user-message"),Content.addHTML(b)}}),o.bind("twitch-giftsub",function(a){Util.StorageAppend(LOG_KEY,a),Content.addHTML(o.get("HTMLGen").giftsub(a))}),o.bind("twitch-anongiftsub",function(a){Util.StorageAppend(LOG_KEY,a),Content.addHTML(o.get("HTMLGen").anongiftsub(a))}),o.bind("twitch-raid",function(a){Util.StorageAppend(LOG_KEY,a),Content.addHTML(o.get("HTMLGen").raid(a))}),o.bind("twitch-newuser",function(a){Util.StorageAppend(LOG_KEY,a);var b=o.get("HTMLGen"),c=b.newUser(a);c.find(".message").addClass("effect-rainbow").addClass("effect-disco"),Content.addHTML(c),Content.addHTML(b.gen(a))}),o.bind("twitch-rewardgift",function(a){Util.StorageAppend(LOG_KEY,a),Content.addHTML(o.get("HTMLGen").rewardGift(a))}),o.bind("twitch-mysterygift",function(a){Util.StorageAppend(LOG_KEY,a),Content.addHTML(o.get("HTMLGen").mysteryGift(a))}),o.bind("twitch-giftupgrade",function(a){Util.StorageAppend(LOG_KEY,a),Content.addHTML(o.get("HTMLGen").giftUpgrade(a))}),o.bind("twitch-primeupgrade",function(a){Util.StorageAppend(LOG_KEY,a),Content.addHTML(o.get("HTMLGen").giftUpgrade(a))}),o.bind("twitch-anongiftupgrade",function(a){Util.StorageAppend(LOG_KEY,a),Content.addHTML(o.get("HTMLGen").giftUpgrade(a))}),o.bind("twitch-otherusernotice",function(a){Util.StorageAppend(LOG_KEY,a),Util.Warn("Unknown USERNOTICE",a)}/* TODO: unraid, bitsbadgetier */),o.bind("twitch-reconnect",function(){/* Client will reconnect automatically */}),o.bind("twitch-join",function(){}),o.bind("twitch-part",function(){}),o.bind("twitch-hosttarget",function(){}),o.bind("twitch-userstate",function(){}),o.bind("twitch-roomstate",function(){}),o.bind("twitch-globaluserstate",function(){}),o.bind("twitch-usernotice",function(){}),o.bind("twitch-ack",function(){}),o.bind("twitch-ping",function(){}),o.bind("twitch-names",function(){}),o.bind("twitch-topic",function(){}),o.bind("twitch-privmsg",function(){}),o.bind("twitch-whisper",function(){}),o.bind("twitch-mode",function(){}),o.bind("twitch-other",function(){}),o.bindDefault(function(a){Util.Warn("Unbound event:",a),Util.StorageAppend(LOG_KEY,a)}),o.Connect()}/* globals AssetPaths Strings CSSCheerStyles GIT_URL CUR_URL LOG_KEY CFG_KEY *//* globals HTMLGenerator GetLayout ParseLayout FormatLayout *//* vim: set ts=2 sts=2 sw=2 et: */