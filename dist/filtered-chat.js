/* Twitch Filtered Chat Main Module */"use strict";/* FIXME:
 * Username context window should slide rather than teleport to new names
 * Chat line backgrounds flicker unpredictably between messages
 * Browser autofills prevent disabling authentication
 *//* TODO (in approximate decreasing priority):
 * Add to content to both #settings help and builder links
 *   Change AssetPaths.BUILDER_WINDOW to use the new builder
 *   shayd3 is working on the builder
 * Create a README.md file for the plugins directory. Include documentation on:
 *   Commands
 *   Filtering
 *   Plugin configuration (?plugincfg)
 * Add configurable message highlighting (//highlight)
 * Auto-complete command arguments
 * Remove F1 hotkey binding
 *//* IDEAS:
 * Add layout selection box to #settings (reloads page on change)?
 * Allow for a configurable number of columns?
 * Add re-include (post-exclude) filtering options for Mods, Bits, Subs, etc?
 *//* Utility functions {{{0 *//* Call func when the input element is changed */var _slicedToArray=function(){function e(e,t){var n=[],a=!0,d=!1,r=void 0;try{for(var i,o=e[Symbol.iterator]();!(a=(i=o.next()).done)&&(n.push(i.value),!(t&&n.length===t));a=!0);}catch(e){d=!0,r=e}finally{try{!a&&o["return"]&&o["return"]()}finally{if(d)throw r}}return n}return function(t,n){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return e(t,n);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},_createClass=function(){function e(e,t){for(var n,a=0;a<t.length;a++)n=t[a],n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}return function(t,n,a){return n&&e(t.prototype,n),a&&e(t,a),t}}();function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function onChange(t,n){var a=!0,d=!1,r=void 0;try{for(var i,o=$(t)[Symbol.iterator]();!(a=(i=o.next()).done);a=!0){var l=i.value,e=$(l);if(e.is("input")){var s=e.attr("type");"text"===s?(e.keyup(function(e){if("Enter"===e.key)return n.bind(this)(e)}),e.blur(function(e){n.bind(this)(e)})):"checkbox"===s?e.change(function(e){n.bind(this)(e)}):e.change(function(e){n.bind(this)(e)})}else e.change(function(e){n.bind(this)(e)})}}catch(e){d=!0,r=e}finally{try{!a&&o.return&&o.return()}finally{if(d)throw r}}}/* End utility functions 0}}} *//* Document writing functions {{{0 */var Content=function(){function t(){_classCallCheck(this,t)}return _createClass(t,null,[{key:"add",/* exported Content */value:function n(e){t.addHTML($("<span class=\"message\"></span>").text(e))}},{key:"addHTML",value:function r(e){var t=Math.pow,n=1<arguments.length&&void 0!==arguments[1]?arguments[1]:null,a=n?$(n):$(".module .content"),d=$("<div class=\"line line-wrapper\"></div>");/* does not escape */"string"==typeof e?d.html(e):e instanceof Node?d.append($(e)):d.append(e),a.append(d),a.attr("data-no-scroll")||a.scrollTop(t(2,31)-1)}},{key:"addPre",value:function n(e){t.addHTML($("<div class=\"pre\"></div>").html(e))}},{key:"addPreText",value:function n(e){t.addHTML($("<div class=\"pre\"></div>").text(e))}},{key:"addInfo",value:function e(n){var a=!!(1<arguments.length&&void 0!==arguments[1])&&arguments[1],d=$("<div class=\"info\"></div>").html(n);/* does not escape */a&&d.addClass("pre"),t.addHTML(d)}},{key:"addInfoText",value:function e(n){var a=!!(1<arguments.length&&void 0!==arguments[1])&&arguments[1],d=$("<div class=\"info\"></div>").text(n);/* escapes */a&&d.addClass("pre"),t.addHTML(d)}},{key:"addNotice",value:function e(n){var a=!!(1<arguments.length&&void 0!==arguments[1])&&arguments[1],d=$("<div class=\"notice\"></div>").html(n);/* does not escape */a&&d.addClass("pre"),t.addHTML(d)}},{key:"addNoticeText",value:function e(n){var a=!!(1<arguments.length&&void 0!==arguments[1])&&arguments[1],d=$("<div class=\"notice\"></div>").text(n);/* escapes */a&&d.addClass("pre"),t.addHTML(d)}},{key:"addError",value:function e(n){var a=!!(1<arguments.length&&void 0!==arguments[1])&&arguments[1],d=$("<div class=\"error\"></div>").html(n);/* does not escape */a&&d.addClass("pre"),t.addHTML(d)}},{key:"addErrorText",value:function e(n){var a=!!(1<arguments.length&&void 0!==arguments[1])&&arguments[1],d=$("<div class=\"error\"></div>").text(n);/* escapes */a&&d.addClass("pre"),t.addHTML(d)}},{key:"addHelp",value:function n(e){t.addPre($("<div class=\"help\"></div>").html(e))}},{key:"addHelpText",value:function n(e){t.addPre($("<div class=\"help\"></div>").text(e))}},{key:"addHelpLine",value:function a(e,n){t.addHelp(ChatCommands.helpLine(e,n))}}]),t}();/* End document writing functions 0}}} *//* Begin configuration section {{{0 *//* Merge the query string into the config object given and return removals */function parseQueryString(e){var t=Math.clamp,n=1<arguments.length&&void 0!==arguments[1]?arguments[1]:null,a={},d=[],r=n||window.location.search;/* Figure out what was passed *//* Generated configuration *//* List of keys to remove from window.location */"string"==typeof r?a=Util.ParseQueryString(r):"object"===("undefined"==typeof r?"undefined":_typeof(r))?a=r:Util.Error("Refusing to parse strange query string object",r);var i=!0,o=!1,l=void 0;try{for(var s,c=Object.entries(a)[Symbol.iterator]();!(i=(s=c.next()).done);i=!0){var u=s.value,p=_slicedToArray(u,2),g=p[0],h=p[1],f=g,m=h;/* config key *//* config val */if("clientid"===g)f="ClientID",e.__clientid_override=!0,d.push(g);else if("user"===g||"name"===g||"nick"===g)f="Name";else if("pass"===g||"oauth"===g)f="Pass",d.push(g);else if("channel"===g||"channels"===g)f="Channels",m=h.split(",").map(function(e){return Twitch.FormatChannel(e)});else if("debug"===g)f="Debug",m="boolean"==typeof h?h:"number"==typeof h?t(h,Util.LEVEL_MIN,Util.LEVEL_MAX):"debug"===h?Util.LEVEL_DEBUG:"trace"===h?Util.LEVEL_TRACE:!!h;else if("noassets"===g)f="NoAssets",m=!!h;else if("noffz"===g)f="NoFFZ",m=!!h;else if("nobttv"===g)f="NoBTTV",m=!!h;else if("hmax"===g)f="HistorySize","inf"===h?m=1/0:"number"==typeof h?m=h:(Util.WarnOnly("Invalid hmax value "+h+"; defaulting"),m=TwitchClient.DEFAULT_HISTORY_SIZE);else if(g.match(/^module[\d]*?$/))f="module"===g?"module1":g,m=parseModuleConfig(h);else if("trans"===g||"transparent"===g)f="Transparent",m=1;else if("layout"===g)f="Layout",m=ParseLayout(h);else if("norec"===g)f="NoAutoReconnect",m=!0;else if("size"===g)f="Size",m=h+"pt";else if("plugins"===g)f="Plugins",m=!!h;else if("disable"===g)f="DisableEffects",m=h.split(",");else if("enable"===g)f="EnableEffects",m=h.split(",");else if("max"===g)f="MaxMessages","inf"===h||-1===h?m=1/0:"number"==typeof h?m=h:(Util.WarnOnly("Invalid max value "+h+"; defaulting"),m=TwitchClient.DEFAULT_MAX_MESSAGES);else if("font"===g)f="Font",m=""+h;else if("scroll"===g)f="Scroll",m=!!h;else if("clips"===g)f="ShowClips",m=!!h;else if("plugincfg"===g){f="PluginConfig";try{m=JSON.parse(h)}catch(t){Util.Error(t),f=m=null}}else if("scheme"===f)f="ColorScheme","light"===h?m="light":"dark"===h?m="dark":(Util.WarnOnly("Invalid scheme value "+h+", defaulting to dark"),m="dark");else if("noforce"===f)f="NoForce",m=!0;else if("fanfare"===f){f="Fanfare",m={enable:!1};try{var b=JSON.parse(h);"number"==typeof b?m.enable=0!==b:"boolean"==typeof b?m.enable=b:"object"===("undefined"==typeof b?"undefined":_typeof(b))?(m=b,m.enable=!0):(Util.Error("Don't know how to parse Fanfare value",b),f=m=null)}catch(t){Util.Error("Failed parsing Fanfare config; disabling",t,h),f=m=null}}/* Skip items with a falsy key */f&&(e[f]=m)}}catch(e){o=!0,l=e}finally{try{!i&&c.return&&c.return()}finally{if(o)throw l}}return d}/* Obtain configuration key */function getConfigKey(){var e=CFG_KEY,t=Util.ParseQueryString(),n=t.config_key||t.key||t["config-key"];return n&&(e=e+"-"+n.replace(/[^a-z]/g,"")),e}/* Obtain configuration */function getConfigObject(){var t=!!(0<arguments.length&&void 0!==arguments[0])&&arguments[0],n=null,a=null,d=Util.ParseQueryString();/* 1) Obtain configuration values
   *  a) from localStorage
   *  b) from query string (overrides (a))
   *  c) from settings elements (overrides (b))
   *  d) from liveStorage (module settings only, overrides (c))
   * 2) Store module configuration in each modules' settings window
   * 3) Remove sensitive values from the query string, if present
   *//* Query String object, parsed *//* Obtain configuration from local storage */if(d.nols)Util.DisableLocalStorage(),a={};else{n=getConfigKey(),Util.SetWebStorageKey(n),n!==CFG_KEY&&Util.LogOnlyOnce("Using custom config key \""+Util.GetWebStorageKey()+"\""),a=Util.GetWebStorage()||{},a.key=n;/* Purge obsolete configuration items */var r=["AutoReconnect"],i=!1,o=!0,l=!1,s=void 0;try{for(var c,u,p=r[Symbol.iterator]();!(o=(c=p.next()).done);o=!0)u=c.value,a.hasOwnProperty(u)&&(i=!0,delete a[u])}catch(e){l=!0,s=e}finally{try{!o&&p.return&&p.return()}finally{if(l)throw s}}i&&Util.SetWebStorage(a)}/* Certain unwanted items may be preserved in localStorage */var g=["NoAssets","Debug","NoAutoReconnect","Layout","Transparent","Plugins","EnableEffects","DisableEffects","PluginConfig","ColorScheme","nols","NoForce"],h=!0,f=!1,m=void 0;try{for(var b,v,S=g[Symbol.iterator]();!(h=(b=S.next()).done);h=!0)v=b.value,a.hasOwnProperty(v)&&delete a[v];/* Parse the query string, storing items to remove */}catch(e){f=!0,m=e}finally{try{!h&&S.return&&S.return()}finally{if(f)throw m}}var y=parseQueryString(a,d);/* Ensure config.Channels is present for #settings configuration below */Util.IsArray(a.Channels)||(a.Channels=[]);/* Obtain global settings config */var x=$("input#txtChannel"),C=$("input#txtNick"),k=$("input#txtPass");if(x.val()){var L=!0,E=!1,T=void 0;try{for(var w,I=x.val().split(",")[Symbol.iterator]();!(L=(w=I.next()).done);L=!0){var H=w.value,P=Twitch.FormatChannel(H.toLowerCase());-1===a.Channels.indexOf(P)&&a.Channels.push(P)}}catch(e){E=!0,T=e}finally{try{!L&&I.return&&I.return()}finally{if(E)throw T}}}/* See if there's any sensitive information we need to remove */if(C.val()&&C.val()!==Strings.NAME_AUTOGEN&&(a.Name=C.val()),t&&k.val()&&k.val()!==Strings.PASS_CACHED&&(a.Pass=k.val()),a.hasOwnProperty("Scroll")||(a.Scroll=$("#cbScroll").is(":checked")),a.hasOwnProperty("ShowClips")||(a.ShowClips=$("#cbClips").is(":checked")),a.hasOwnProperty("NoForce")||(a.NoForce=$("#cbForce").is(":checked")),$(".module").each(function(){var e=$(this).attr("id"),t=function(e){return Util.IsArray(e)?e:[]};/* Populate module configuration from liveStorage (if present) */if(a[e]||(a[e]=getModuleSettings($(this))),window.liveStorage&&window.liveStorage[e]){var n=!0,d=!1,r=void 0;try{for(var i,o=Object.entries(window.liveStorage[e])[Symbol.iterator]();!(n=(i=o.next()).done);n=!0){var l=i.value,s=_slicedToArray(l,2),c=s[0],u=s[1];a[e][c]=u}}catch(e){d=!0,r=e}finally{try{!n&&o.return&&o.return()}finally{if(d)throw r}}}/* Ensure all the settings have the proper types */a[e].Pleb=!!a[e].Pleb,a[e].Sub=!!a[e].Sub,a[e].VIP=!!a[e].VIP,a[e].Mod=!!a[e].Mod,a[e].Event=!!a[e].Event,a[e].Bits=!!a[e].Bits,a[e].Me=!!a[e].Me,a[e].IncludeKeyword=t(a[e].IncludeKeyword),a[e].IncludeUser=t(a[e].IncludeUser),a[e].ExcludeUser=t(a[e].ExcludeUser),a[e].ExcludeStartsWith=t(a[e].ExcludeStartsWith),a[e].FromChannel=t(a[e].FromChannel)}),0<y.length){Util.SetWebStorage(a);/* Obtain the current query string */var M=Util.ParseQueryString(window.location.search.substr(1)),A=!1;M.base64&&0<M.base64.length&&(A=!0,M=Util.ParseQueryString(atob(M.base64)));/* Remove the sensitive items */var N=!0,_=!1,F=void 0;try{for(var D,O,G=y[Symbol.iterator]();!(N=(D=G.next()).done);N=!0)O=D.value,delete M[O];/* Create and apply a new query string */}catch(e){_=!0,F=e}finally{try{!N&&G.return&&G.return()}finally{if(_)throw F}}var B=Util.FormatQueryString(M);A&&(B="?base64="+encodeURIComponent(btoa(B))),window.location.search=B}/* Merge in top-level liveStorage items */if(window.liveStorage){var U=!0,R=!1,W=void 0;try{for(var j,V,z=Object.keys(window.liveStorage)[Symbol.iterator]();!(U=(j=z.next()).done);U=!0)V=j.value,V.match(/^module[0-9]*$/)||a[V]===window.liveStorage[V]||(a[V]=window.liveStorage[V])}catch(e){R=!0,W=e}finally{try{!U&&z.return&&z.return()}finally{if(R)throw W}}}/* Finally, ensure certain defaults *//* Default name is no name */return"string"!=typeof a.Name&&(a.Name=""),a.hasOwnProperty("Plugins")||(a.Plugins=!1),a.hasOwnProperty("Debug")||(a.Debug=!1),a.hasOwnProperty("Channels")||(a.Channels=[]),a.hasOwnProperty("Layout")||(a.Layout=GetLayout()),a.hasOwnProperty("MaxMessages")||(a.MaxMessages=TwitchClient.DEFAULT_MAX_MESSAGES),a.hasOwnProperty("HistorySize")||(a.HistorySize=TwitchClient.DEFAULT_HISTORY_SIZE),t?!a.ClientID&&(a.ClientID=[19,86,67,115,22,38,198,3,55,118,67,35,150,230,71,134,83,3,119,166,86,39,38,167,135,134,147,214,38,55].map(function(e){return Util.ASCII[16*(15&e)+(240&e)/16]}).join("")):(a.ClientID=null,delete a.ClientID,delete a.Pass),a}/* Obtain singular configuration */function getConfigValue(e){return getConfigObject()[e]}/* Store configuration */function mergeConfigObject(){var e=0<arguments.length&&arguments[0]!==void 0?arguments[0]:null,t=e||{},n=getConfigObject(!0);if(Util.IsArray(t)){var a=!0,d=!1,r=void 0;try{for(var i,o=t[Symbol.iterator]();!(a=(i=o.next()).done);a=!0){var l=i.value,s=_slicedToArray(l,2),c=s[0],u=s[1];n[c]=u}}catch(e){d=!0,r=e}finally{try{!a&&o.return&&o.return()}finally{if(d)throw r}}}else{var p=!0,g=!1,h=void 0;try{for(var f,m=Object.entries(t)[Symbol.iterator]();!(p=(f=m.next()).done);p=!0){var b=f.value,v=_slicedToArray(b,2),S=v[0],y=v[1];n[S]=y}}catch(e){g=!0,h=e}finally{try{!p&&m.return&&m.return()}finally{if(g)throw h}}}Util.SetWebStorage(n),window.liveStorage=n}/* Module configuration {{{1 *//* Enumerate the active modules */function getModules(){/* exported getModules */var e={},t=!0,n=!1,a=void 0;try{for(var d,r,i=$(".module")[Symbol.iterator]();!(t=(d=i.next()).done);t=!0)r=d.value,e[$(r).attr("id")]=r}catch(e){n=!0,a=e}finally{try{!t&&i.return&&i.return()}finally{if(n)throw a}}return e}/* Apply configuration to the module's settings HTML */function setModuleSettings(e,t){function n(e,t,n){if(n&&0<n.length){var d=!0,r=!1,i=void 0;try{for(var o,l=n[Symbol.iterator]();!(d=(o=l.next()).done);d=!0){var s=o.value,c=$("<li></li>"),u="input."+CSS.escape(e)+"[value=\""+CSS.escape(s)+"\"]";if(0===a.find(u).length){var p=$("<label></label>").val(t),g=$("<input type=\"checkbox\" checked />");g.addClass(e),g.attr("value",s),g.click(updateModuleConfig),p.append(g),p.html(p.html()+t+s.escape()),c.append(p),a.find("li."+CSS.escape(e)).before(c)}}}catch(e){r=!0,i=e}finally{try{!d&&l.return&&l.return()}finally{if(r)throw i}}}}var a=$(e);t.Name&&(a.find("label.name").html(t.Name),a.find("input.name").val(t.Name)),a.find("input.pleb").check(t.Pleb),a.find("input.sub").check(t.Sub),a.find("input.vip").check(t.VIP),a.find("input.mod").check(t.Mod),a.find("input.event").check(t.Event),a.find("input.bits").check(t.Bits),a.find("input.me").check(t.Me),n("include_user","From: ",t.IncludeUser),n("include_keyword","Contains: ",t.IncludeKeyword),n("exclude_user","From: ",t.ExcludeUser),n("exclude_startswith","Starts with: ",t.ExcludeStartsWith),n("from_channel","Channel: ",t.FromChannel)}/* Obtain the settings from the module's settings HTML */function getModuleSettings(e){var t=$(e),n={Name:t.find("input.name").val(),Pleb:t.find("input.pleb").is(":checked"),Sub:t.find("input.sub").is(":checked"),VIP:t.find("input.vip").is(":checked"),Mod:t.find("input.mod").is(":checked"),Event:t.find("input.event").is(":checked"),Bits:t.find("input.bits").is(":checked"),Me:t.find("input.me").is(":checked"),IncludeUser:[],IncludeKeyword:[],ExcludeUser:[],ExcludeStartsWith:[],FromChannel:[]};return t.find("input.include_user:checked").each(function(){n.IncludeUser.push($(this).val())}),t.find("input.include_keyword:checked").each(function(){n.IncludeKeyword.push($(this).val())}),t.find("input.exclude_user:checked").each(function(){n.ExcludeUser.push($(this).val())}),t.find("input.exclude_startswith:checked").each(function(){n.ExcludeStartsWith.push($(this).val())}),t.find("input.from_channel:checked").each(function(){n.FromChannel.push($(this).val())}),n}/* Parse a module configuration object from a query string component */function parseModuleConfig(e){for(var t=function(e){return e.map(function(e){return decodeURIComponent(e)})},n=t(e.split(/,/g));7>n.length;)n.push("");/* Upgrade configuration from 6x to 7x */"111111"===n[1]&&(n[1]="1111111");var a=Util.DecodeFlags(n[1],7),d={};return d.Name=n[0],d.Pleb=a[0],d.Sub=a[1],d.VIP=a[2],d.Mod=a[3],d.Event=a[4],d.Bits=a[5],d.Me=a[6],d.IncludeKeyword=n[2]?t(n[2].split(/,/g)):[],d.IncludeUser=n[3]?t(n[3].split(/,/g)):[],d.ExcludeUser=n[4]?t(n[4].split(/,/g)):[],d.ExcludeStartsWith=n[5]?t(n[5].split(/,/g)):[],d.FromChannel=n[6]?t(n[6].split(/,/g)):[],d}/* Format the module configuration object into a query string component */function formatModuleConfig(e){var t=function(e){return e.map(function(e){return encodeURIComponent(e)})},n=[e.Pleb,e.Sub,e.VIP,e.Mod,e.Event,e.Bits,e.Me],a=[e.Name,Util.EncodeFlags(n,!1),t(e.IncludeKeyword).join(","),t(e.IncludeUser).join(","),t(e.ExcludeUser).join(","),t(e.ExcludeStartsWith).join(","),t(e.FromChannel).join(",")];return t(a).join(",")}/* Store the modules' settings in both localStorage and liveStorage */function updateModuleConfig(){var e={};$(".module").each(function(){var t=$(this).attr("id");e[t]=getModuleSettings($(this)),window.liveStorage||(window.liveStorage={}),window.liveStorage[t]=e[t]}),mergeConfigObject(e)}/* End module configuration 1}}} *//* Set the joined channels to the list given */function setChannels(e,t){var n=function(e){return Twitch.FormatChannel(Twitch.ParseChannel(e))},a=t.map(n),d=e.GetJoinedChannels().map(n),r=a.filter(function(e){return-1===d.indexOf(e)}),i=d.filter(function(e){return-1===a.indexOf(e)}),o=!0,l=!1,s=void 0;/* Join all the channels added */try{for(var c,u,p=r[Symbol.iterator]();!(o=(c=p.next()).done);o=!0)u=c.value,e.JoinChannel(u),Content.addNoticeText("Joining "+u);/* Leave all the channels removed */}catch(e){l=!0,s=e}finally{try{!o&&p.return&&p.return()}finally{if(l)throw s}}var g=!0,h=!1,f=void 0;try{for(var m,b,v=i[Symbol.iterator]();!(g=(m=v.next()).done);g=!0)b=m.value,e.LeaveChannel(b),Content.addNoticeText("Leaving "+b)}catch(e){h=!0,f=e}finally{try{!g&&v.return&&v.return()}finally{if(h)throw f}}}/* End configuration section 0}}} *//* Return whether or not the event should be filtered */function shouldFilter(e,t){var n=getModuleSettings(e);if(window.Plugins&&!window.PluginsAreDisabled){var y=Plugins.invoke("shouldFilter",e,t);if(y&&0<y.length){var a=!0,d=!1,r=void 0;try{for(var o,l,c=y[Symbol.iterator]();!(a=(o=c.next()).done);a=!0)if(l=o.value,"boolean"==typeof l)return l;/* Other values: continue the filtering logic */}catch(e){d=!0,r=e}finally{try{!a&&c.return&&c.return()}finally{if(d)throw r}}}}if(t instanceof TwitchChatEvent){var p=t.user||"",g=t.message?t.message.toLowerCase():"",h="pleb";/* NOTE: pleb < sub < vip < mod *//* Includes take priority over excludes */if(t.issub&&(h="sub"),t.isvip&&(h="vip"),t.ismod&&(h="mod"),n.IncludeUser.any(function(e){return e.equalsLowerCase(p)}))return!1;if(n.IncludeKeyword.any(function(e){return-1<g.indexOf(e)}))return!1;/* Role filtering */if(!n.Pleb&&"pleb"==h)return!0;if(!n.Sub&&"sub"==h)return!0;if(!n.VIP&&"vip"==h)return!0;if(!n.Mod&&"mod"==h)return!0;/* Content filtering ("Bits" also filters out cheer effects) */if(!n.Bits&&t.flags.bits)return!0;if(!n.Me&&t.flags.action)return!0;/* Exclude filtering */if(n.ExcludeUser.any(function(e){return e.equalsLowerCase(p)}))return!0;if(n.ExcludeStartsWith.any(function(e){return g.startsWith(e)}))return!0;/* Filtering to permitted channels (default: permit all) */if(0<n.FromChannel.length){var f=!0,m=!1,b=void 0;try{for(var v,S,u=n.FromChannel[Symbol.iterator]();!(f=(v=u.next()).done);f=!0)if(S=v.value,t.channelString.equalsLowerCase(S))return!0}catch(e){m=!0,b=e}finally{try{!f&&u.return&&u.return()}finally{if(m)throw b}}return!1}}else if(t instanceof TwitchEvent&&!n.Event&&("USERNOTICE"===t.command||"NOTICE"===t.command))/* Filter out events and notices */return!0;return!1}/* Populate and show the username context window */function showUserContextWindow(e,n,a){var i=Math.round,o=Number.parseInt;/* Define functions for building elements */function d(e){var t=$("<div class=\"item\"></div>");return"string"==typeof e?t.html(e):t.append(e),t}function r(e,t){var n=$("<a class=\"cw-link\"></a>");return n.attr("id",e),n.text(t),n}var s=$(n),c=$(a),u=c.attr("data-id"),p=c.attr("data-user"),g=c.find(".username").text(),f=c.attr("data-user-id"),m="#"+c.attr("data-channel"),b=c.attr("data-channelid"),v="1"===c.attr("data-subscriber"),S="1"===c.attr("data-mod"),y="1"===c.attr("data-vip"),x="1"===c.attr("data-caster"),C=o(c.attr("data-sent-ts")),k=new Date(C);/* Attributes of the host line */s.html(""),s.attr("data-id",u),s.attr("data-user",p),s.attr("data-user-id",f),s.attr("data-channel",m),s.attr("data-chid",b),s.attr("data-sub",v),s.attr("data-mod",S),s.attr("data-vip",y),s.attr("data-caster",x),s.attr("data-id",u);var L=function(e){return $("<span class=\"em pad\"></span>").html(e)},E=c.find(".username"),T=E.attr("class").escape(),I=E.attr("style").escape();/* Add user's display name *//* Add link to timeout user */if(s.append(d("<span class=\""+T+"\" style=\""+I+"\">"+g+"</span>"+" in <span class=\"em\">"+m+"</span>")),e.IsMod(m)){var H=$("<div class=\"cw-timeout\">Timeout:</div>"),P=!0,M=!1,A=void 0;try{for(var N,_=["1s","10s","60s","10m","30m","1h","12h","24h"][Symbol.iterator]();!(P=(N=_.next()).done);P=!0){var F=N.value,D=r("cw-timeout-"+p+"-"+F,F);D.addClass("cw-timeout-dur"),D.attr("data-channel",m),D.attr("data-user",p),D.attr("data-duration",F),D.click(function(){var t=$(this).attr("data-channel"),a=$(this).attr("data-user"),r=$(this).attr("data-duration");e.Timeout(t,a,r),Util.Log("Timed out user "+a+" from "+t+" for "+r),$(n).fadeOut()}),H.append(D)}}catch(e){M=!0,A=e}finally{try{!P&&_.return&&_.return()}finally{if(M)throw A}}s.append(H)}/* Add link which places "/ban <user>" into the chat textbox */if(e.IsMod(m)){var Y=r("cw-ban-"+p,"Ban");Y.addClass("cw-ban-user"),Y.attr("data-channel",m),Y.attr("data-user",p),Y.click(function(){$("#txtChat").val("/ban "+$(this).attr("data-user"))}),s.append(Y)}/* Add other information */var O=Util.FormatDate(k),G=Util.FormatInterval((Date.now()-C)/1e3);/* Add roles (and ability to remove roles, for the caster) */if(s.append(d("Sent: "+O+" ("+G+" ago)")),s.append(d("UserID: "+f)),s.append(d("MsgUID: "+u)),S||y||v||x){var U=d("User Role: "),R=[];if(S&&R.push(L("Mod")),y&&R.push(L("VIP")),v&&R.push(L("Sub")),x&&R.push(L("Host")),0<R.length){U.append(R[0]);var W=!0,j=!1,V=void 0;try{for(var z,B,K=R.slice(1)[Symbol.iterator]();!(W=(z=K.next()).done);W=!0)B=z.value,U.append(", "),U.append(B)}catch(e){j=!0,V=e}finally{try{!W&&K.return&&K.return()}finally{if(j)throw V}}s.append(U)}e.IsCaster(m)&&!e.IsUIDSelf(f)&&(S&&s.append(d(r("cw-unmod","Remove Mod"))),y&&s.append(d(r("cw-unvip","Remove VIP"))))}/* Add the ability to add roles (for the caster) */e.IsCaster(m)&&!e.IsUIDSelf(f)&&(!S&&s.append(d(r("cw-make-mod","Make Mod"))),!y&&s.append(d(r("cw-make-vip","Make VIP")))),Util.Trace("Showing ucw for",c);var X=c.offset(),q=i(X.top)+c.outerHeight()+2,t=i(X.left),l=s.outerWidth(),w=s.outerHeight(),h={top:q,left:t,width:l,height:w};Util.ClampToScreen(h),delete h.width,delete h.height,s.fadeIn().offset(h)}/* Set or unset transparency */function updateTransparency(e){/* exported updateTransparency */var t=[];try{var n=Util.CSS.GetSheet("main.css"),a=Util.CSS.GetRule(n,":root"),d=!0,r=!1,i=void 0;/* Find the prop="--<name>-color" rules */try{for(var o,l,s=Util.CSS.GetPropertyNames(a)[Symbol.iterator]();!(d=(o=s.next()).done);d=!0)l=o.value,l.match(/^--[a-z-]+-color$/)&&t.push(l)}catch(e){r=!0,i=e}finally{try{!d&&s.return&&s.return()}finally{if(r)throw i}}}catch(n){/* Unable to enumerate properties; use hard-coded ones */Util.ErrorOnce("Failed getting main.css :root",n),t=["--body-color","--header-color","--menudiv-color","--module-color","--odd-line-color","--sub-color","--chat-color","--textarea-color"]}var c=!0,u=!1,p=void 0;try{for(var g,h,f=t[Symbol.iterator]();!(c=(g=f.next()).done);c=!0)h=g.value,e?(Util.CSS.SetProperty(h,"transparent"),$(".module").addClass("transparent"),$("body").addClass("transparent")):(Util.CSS.SetProperty(h,"var("+h+"-default)"),$(".module").removeClass("transparent"),$("body").removeClass("transparent"))}catch(e){u=!0,p=e}finally{try{!c&&f.return&&f.return()}finally{if(u)throw p}}}/* Set the colorscheme to dark */function setDarkScheme(){/* exported setDarkScheme */$("body").removeClass("light").addClass("dark"),$("#btnSettings").attr("src",AssetPaths.SETTINGS)}/* Set the colorscheme to light */function setLightScheme(){/* exported setLightScheme */$("body").removeClass("dark").addClass("light"),$("#btnSettings").attr("src",AssetPaths.SETTINGS_LIGHT)}/* Set or clear window notification badge */function setNotify(){var e=!(0<arguments.length&&arguments[0]!==void 0)||arguments[0],t=e?AssetPaths.FAVICON_ALERT:AssetPaths.FAVICON;/* exported setNotify */$("link[rel=\"shortcut icon\"]").attr("href",t)}/* Called once when the document loads */function doLoadClient(){var c=Number.parseInt,u=Math.clamp;/* Function for syncing configuration with HTMLGen */function e(){var e=!0,t=!1,n=void 0;try{for(var a,d=Object.entries(getConfigObject())[Symbol.iterator]();!(e=(a=d.next()).done);e=!0){var r=a.value,i=_slicedToArray(r,2),o=i[0],l=i[1];p.get("HTMLGen").setValue(o,l)}}catch(e){t=!0,n=e}finally{try{!e&&d.return&&d.return()}finally{if(t)throw n}}}/* Construct the plugins *//* Close the main settings window */function t(){updateModuleConfig(),$("#settings").fadeOut()}/* Open the main settings window */function n(){var e=getConfigObject(!0);$("#txtChannel").val(e.Channels.join(",")),$("#txtNick").val(e.Name||Strings.NAME_AUTOGEN),e.Pass&&0<e.Pass.length&&($("#txtPass").attr("disabled","disabled").hide(),$("#txtPassDummy").show()),$("#selDebug").val(""+e.Debug),$("#settings").fadeIn()}/* Toggle the main settings window */function a(){$("#settings").is(":visible")?t():n()}/* Close a module's settings window */function d(e){updateModuleConfig();var t=$(e).find(".settings"),n=t.siblings("input.name"),a=t.siblings("label.name");n.hide(),a.html(n.val()).show(),t.fadeOut()}/* Open a module's settings window */function r(e){var t=$(e).find(".settings"),n=t.siblings("input.name"),a=t.siblings("label.name");a.hide(),n.val(a.html()).show(),t.fadeIn()}/* Toggle a module's settings window */function i(e){var t=$(e).find(".settings");t.is(":visible")?d(e):r(e)}/* Reset chat auto-completion variables */function o(){var e=$("#txtChat");e.attr("data-complete-text",""),e.attr("data-complete-pos","-1"),e.attr("data-complete-index","0")}/* Reset chat history recall */function l(){$("#txtChat").attr("data-hist-index","-1")}/* Initialize chat auto-completion and history *//* Open the settings builder page */function s(){Util.Open(AssetPaths.BUILDER_WINDOW,"_blank",{})}/* Add command to open the settings builder page *//* exported doLoadClient */var p=void 0,g={};/* Hook Logger messages to display in chat *//* Disable configured events */if(Util.Logger.add_hook(function(){if(Util.DebugLevel>=Util.LEVEL_DEBUG){for(var e,t=arguments.length,n=Array(2<t?t-2:0),a=2;a<t;a++)n[a-2]=arguments[a];var d=(e=Util.Logger).stringify.apply(e,n);Content.addErrorText("ERROR: "+d)}},"ERROR"),Util.Logger.add_hook(function(){for(var e,t=arguments.length,n=Array(2<t?t-2:0),a=2;a<t;a++)n[a-2]=arguments[a];var d=(e=Util.Logger).stringify.apply(e,n);1===n.length&&n[0]instanceof TwitchEvent?Util.DebugLevel>=Util.LEVEL_TRACE&&Content.addNoticeText("WARNING: "+JSON.stringify(n[0])):Util.DebugLevel>=Util.LEVEL_DEBUG&&Content.addNoticeText("WARNING: "+d)},"WARN"),Util.Logger.add_hook(function(){if(Util.DebugLevel>=Util.LEVEL_TRACE){for(var e,t=arguments.length,n=Array(2<t?t-2:0),a=2;a<t;a++)n[a-2]=arguments[a];var d=(e=Util.Logger).stringify.apply(e,n);Content.add("DEBUG: "+d)}},"DEBUG"),Util.Logger.add_hook(function(){if(Util.DebugLevel>=Util.LEVEL_TRACE){for(var e,t=arguments.length,n=Array(2<t?t-2:0),a=2;a<t;a++)n[a-2]=arguments[a];var d=(e=Util.Logger).stringify.apply(e,n);Content.add("TRACE: "+d)}},"TRACE"),Util.DebugLevel<Util.LEVEL_TRACE&&(Util.Logger.add_filter(/^ws recv> "PING :tmi.twitch.tv"$/),Util.Logger.add_filter(/^ws send> "PONG :tmi.twitch.tv"$/),Util.Logger.add_filter(/tmi.twitch.tv (JOIN|PART) #/)),$("#txtNick").val(),$("#txtPass").val(),ChatCommands.add("config",function(e,n){var a=Number.parseFloat,d=getConfigObject(!0),r=0<n.length?n[0]:"";if(0===n.length){var le=[];Content.addHelp("<em>Global Configuration Values:</em>");var i=!0,o=!1,l=void 0;try{for(var s,u=Object.entries(d)[Symbol.iterator]();!(i=(s=u.next()).done);i=!0){var p=s.value,g=_slicedToArray(p,2),h=g[0],f=g[1],m=h,b="object"===("undefined"==typeof f?"undefined":_typeof(f))?JSON.stringify(f):""+f;"Layout"===h?b=FormatLayout(f):"ClientID"===h?b="Omitted for security; use //config clientid to show":"Pass"===h?b="Omitted for security; use //config pass to show":"object"===("undefined"==typeof f?"undefined":_typeof(f))&&f.Name&&0<f.Name.length&&(m=b=null,le.push([h,f])),null!==m&&Content.addHelpLine(m,b)}}catch(e){o=!0,l=e}finally{try{!i&&u.return&&u.return()}finally{if(o)throw l}}Content.addHelp("<em>Window Configuration Values:</em>");var v=!0,S=!1,y=void 0;try{for(var x,C=le[Symbol.iterator]();!(v=(x=C.next()).done);v=!0){var k=x.value,L=_slicedToArray(k,2),E=L[0],T=L[1],w=function(t){return"&quot;"+t+"&quot"},I="&quot;"+T.Name+"&quot;";Content.addHelpText("Module "+("<span class=\"arg\">"+E+"</span>")+": "+I);var H=!0,P=!1,M=void 0;try{for(var A,N=Object.entries(T)[Symbol.iterator]();!(H=(A=N.next()).done);H=!0){var _=A.value,F=_slicedToArray(_,2),D=F[0],O=F[1];"Name"!==D&&Content.addHelpLine(D,w(O))}}catch(e){P=!0,M=e}finally{try{!H&&N.return&&N.return()}finally{if(P)throw M}}}}catch(e){S=!0,y=e}finally{try{!v&&C.return&&C.return()}finally{if(S)throw y}}}else if("help"===r)Content.addHelpLine("//config","Show and manipulate configuration"),Content.addHelpText("//config parameters:"),Content.addHelpLine("export","Export *all* of localStorage to a new tab (contains passwords!)"),Content.addHelpLine("purge","Clear localStorage (cannot be undone!)"),Content.addHelpLine("clientid","Display ClientID"),Content.addHelpLine("pass","Dislay OAuth token (if one is present)"),Content.addHelpLine("url","Generate a URL from the current configuration"),Content.addHelpText("//config url parameters (can be used in any order):"),Content.addHelpLine("git","Force URL to target github.io"),Content.addHelpLine("text","Force URL to be un-encoded"),Content.addHelpLine("auth","Include passwords in URL"),Content.addHelpLine("tag=&lt;value&gt;","Set the tag to &lt;value&gt;"),Content.addHelpText("//config set <key> <value>: Change <key> to <value> (dangerous!)"),Content.addHelpText("//config setobj <key> <value>: Change <key> to JSON-encoded <value> (dangerous!)"),Content.addHelpText("//config unset <key>: Remove <key> (dangerous!)");else if("export"===r)Util.Open(AssetPaths.CONFIG_EXPORT_WINDOW,"_blank",{});else if("purge"===r)Util.SetWebStorage({}),window.liveStorage={},Content.addNoticeText("Purged storage \""+Util.GetWebStorageKey()+"\"");else if("clientid"===r)Content.addHelpLine("ClientID",d.ClientID);else if("pass"===r)Content.addHelpLine("Pass",d.Pass);else if("url"===r){/* Generate a URL with the current configuration, omitting items
       * left at default values *//* Base URL, query string array, and function to add items */var G=-1<n.indexOf("git")?GIT_URL:CUR_URL,U=[],R=function(e,t){return U.push(e+"="+encodeURIComponent(t))};0<d.Debug&&R("debug",d.Debug),d.__clientid_override&&R("clientid",d.ClientID),R("channels",d.Channels.join(",")),d.NoAssets&&R("noassets",d.NoAssets),d.NoFFZ&&R("noffz",d.NoFFZ),d.NoBTTV&&R("nobttv",d.NoBTTV),d.HistorySize&&R("hmax",d.HistorySize);var W=!0,j=!1,V=void 0;try{for(var z,B,K=Object.keys(getModules())[Symbol.iterator]();!(W=(z=K.next()).done);W=!0)B=z.value,R(B,formatModuleConfig(d[B]))}catch(e){j=!0,V=e}finally{try{!W&&K.return&&K.return()}finally{if(j)throw V}}R("layout",FormatLayout(d.Layout)),d.Transparent&&R("trans","1"),d.NoAutoReconnect&&R("norec","1");var X=Util.CSS.GetProperty("--body-font-size"),q=Util.CSS.GetProperty("--body-font-size-default");X!==q&&R("size",X.replace(/[^0-9]/g,"")),d.Plugins&&R("plugins","1"),d.MaxMessages!==TwitchClient.DEFAULT_MAX_MESSAGES&&R("max",""+d.MaxMessages),d.Font&&R("font",d.Font),d.Scroll&&R("scroll","1"),d.ShowClips&&R("clips","1"),-1<n.indexOf("auth")&&(R("user",d.Name),R("pass",d.Pass)),d.DisableEffects&&R("disable",d.DisableEffects.join(",")),d.EnableEffects&&R("enable",d.EnableEffects.join(",")),d.PluginConfig&&R("plugincfg",JSON.stringify(d.PluginConfig)),"dark"===d.ColorScheme?R("scheme","dark"):"light"===d.ColorScheme&&R("scheme","light"),d.NoForce&&R("noforce","1"),d.Fanfare&&R("fanfare",JSON.stringify(d.Fanfare));/* Append a tag */var Y=d.tag?d.tag:"",Q=!0,J=!1,Z=void 0;try{for(var ee,te,ne=n.slice(1)[Symbol.iterator]();!(Q=(ee=ne.next()).done);Q=!0)te=ee.value,te.startsWith("tag=")&&(Y=te.substr(4))}catch(e){J=!0,Z=e}finally{try{!Q&&ne.return&&ne.return()}finally{if(J)throw Z}}Y&&R("tag",Y),G+=n.includes("text")?"?"+U.join("&"):"?base64="+encodeURIComponent(btoa(U.join("&"))),Content.addHelp($("<a></a>").attr("href",G).text(G))}else if(("set"===r||"setobj"===r)&&2<n.length){/* Allow changing configuration by command (dangerous) */var ae=n[1],de=n.slice(2).join(" "),re=null;re="setobj"===r?JSON.parse(de):"true"===de||"false"!==de&&("Infinity"===de?1/0:"-Infinity"===de?-Infinity:"NaN"===de?NaN:de.match(/^[+-]?(?:\d|[1-9]\d*)$/)?c(de):de.match(/^[-+]?(?:\d*\.\d+|\d+)$/)?a(de):de);var se=JSON.stringify(re);if(Util.ObjectHas(d,ae)){var ie=Util.ObjectGet(d,ae),oe=JSON.stringify(ie);Content.addHelpText("Changing "+ae+" from \""+oe+"\" to \""+se+"\""),Content.addHelpLine(ae,oe),Content.addHelpLine(ae,se),Util.ObjectSet(d,ae,re),mergeConfigObject(d)}else Content.addHelpText("Adding key "+ae+" with value \""+se+"\""),Content.addHelpLine(ae,se),Util.ObjectSet(d,ae,re),mergeConfigObject(d)}else if("unset"===r&&1<n.length){var ce=n[1];Util.ObjectRemove(d,ce)?(Content.addHelpText("Removed key "+ce+" from localStorage"),Util.SetWebStorage(d)):Content.addHelpText("Failed to remove key "+ce+" from localStorage"),window.liveStorage&&(Util.ObjectRemove(window.liveStorage,ce)?Content.addHelpText("Removed key "+ce+" from liveStorage"):Content.addHelpText("Failed to removed key "+ce+" from liveStorage"))}else if(Util.ObjectHas(d,r))Content.addHelpText("Configuration:"),Content.addHelpLine(r,JSON.stringify(Util.ObjectGet(d,r)));else{Content.addErrorText("Unknown config command or key "+("\""+r+"\""),!0)}},"Obtain and modify configuration information; use //config help for details"),function(){var e=getConfigObject(!0);p=new TwitchClient(e),Util.DebugLevel=e.Debug,document.title+=" -",e.Pass&&0<e.Pass.length?document.title+=" Authenticated":(document.title+=" Read-Only",e.Layout.Chat&&($("#txtChat").attr("placeholder","Authentication needed to send messages"),Util.CSS.SetProperty("--chat-border","#cd143c"))),g=getConfigObject(),g.Plugins=!!e.Plugins,g.Pass=g.ClientID=null,delete g.Pass,delete g.ClientID}(),$(".module").each(function(){setModuleSettings(this,g[$(this).attr("id")])}),g.DisableEffects){var h=!0,f=!1,m=void 0;try{for(var b,v,S=g.EnableEffects[Symbol.iterator]();!(h=(b=S.next()).done);h=!0)v=b.value,CSSCheerStyles[v]&&(CSSCheerStyles[v]._disabled=!0)}catch(e){f=!0,m=e}finally{try{!h&&S.return&&S.return()}finally{if(f)throw m}}}/* Enable configured effects */if(g.EnableEffects){var y=!0,x=!1,C=void 0;try{for(var k,L,E=g.EnableEffects[Symbol.iterator]();!(y=(k=E.next()).done);y=!0)L=k.value,CSSCheerStyles[L]&&(CSSCheerStyles[L]._disabled=!1)}catch(e){x=!0,C=e}finally{try{!y&&E.return&&E.return()}finally{if(x)throw C}}}/* Simulate clicking cbTransparent if config.Transparent is set */g.Transparent?(updateTransparency(!0),$("#cbTransparent").check()):$("#cbTransparent").uncheck(),g.Size&&Util.CSS.SetProperty("--body-font-size",g.Size),g.Font&&Util.CSS.SetProperty("--body-font",g.Font),g.Scroll?($(".module .content").css("overflow-y","scroll"),$("#cbScroll").check()):$("#cbScroll").uncheck(),0===g.Channels.length&&$("#settings").fadeIn(),g.ShowClips?$("#cbClips").check():$("#cbClips").uncheck(),g.NoForce?$("#cbForce").check():$("#cbForce").uncheck(),"dark"===g.ColorScheme?setDarkScheme():"light"===g.ColorScheme&&setLightScheme(),g.NoAnim?$("#cbAnimCheers").uncheck():$("#cbAnimCheers").check(),$("#txtBGStyle").val(""),g.Font?$("#txtFont").val(g.Font):$("#txtFont").val(Util.CSS.GetProperty("--body-font")),g.Size?$("#txtFontSize").val(g.Size):$("#txtFontSize").val(Util.CSS.GetProperty("--body-font-size")),g.tag&&$("#txtTag").val(g.tag),p.set("HTMLGen",new HTMLGenerator(p,g)),p.set("Fanfare",new Fanfare(p,g)),g.Plugins?Plugins.loadAll(p,g):Plugins.disable(),Util.DebugLevel>=Util.LEVEL_DEBUG&&(window.client=p),ChatCommands.addHelp("Moderator commands:",{literal:!0}),ChatCommands.addHelp("!tfc reload: Reload the page",{literal:!0,command:!0}),ChatCommands.addHelp("!tfc force-reload: Reload the page, discarding cache",{literal:!0,command:!0}),ChatCommands.addHelp("!tfc nuke: Completely clear the chat",{literal:!0,command:!0}),ChatCommands.addHelp("!tfc nuke <user>: Clear messages sent by <user>",{args:!0,command:!0}),ChatCommands.addHelp("!tfc ffdemo: Demonstrate fanfares",{literal:!0,command:!0}),ChatCommands.addHelp("!tfc ffcheerdemo: Demonstrate default cheer fanfare",{literal:!0,command:!0}),ChatCommands.addHelp("!tfc ffsubdemo: Demonstrate default sub fanfare",{literal:!0,command:!0}),o(),l(),ChatCommands.add("builder",function(){s()},"Open the configuration builder wizard"),$("#txtChat").keydown(function(n){var e=Number.isNaN,a=event.target;if("Enter"===n.key)return 0<a.value.trim().length&&(ChatCommands.isCommandStr(a.value)?ChatCommands.execute(a.value,p):p.SendMessageToAll(a.value),p.AddHistory(a.value),a.value="",o(),l()),n.preventDefault(),!1;if("Tab"===n.key){/* TODO: Complete command arguments and @user names */var t=a.getAttribute("data-complete-text")||a.value,r=c(a.getAttribute("data-complete-pos")),s=c(a.getAttribute("data-complete-index"));(e(r)||-1===r)&&(r=a.selectionStart),e(s)&&(s=0);var d={orig_text:t,orig_pos:r,curr_text:a.value,curr_pos:a.selectionStart,index:s};return d=ChatCommands.complete(p,d),a.setAttribute("data-complete-text",d.orig_text),a.setAttribute("data-complete-pos",d.orig_pos),a.setAttribute("data-complete-index",d.index),a.value=d.curr_text,requestAnimationFrame(function(){a.selectionStart=d.curr_pos,a.selectionEnd=d.curr_pos}),l(),n.preventDefault(),!1}if("ArrowUp"===n.key||"ArrowDown"===n.key){/* Handle traversing message history */var g=c($(this).attr("data-hist-index")),h="ArrowUp"===n.key?1:-1;g=u(g+h,-1,p.GetHistoryLength()-1);var f=p.GetHistoryItem(g);null!==f&&(a.value=f.trim()),a.setAttribute("data-hist-index",""+g),requestAnimationFrame(function(){a.selectionStart=a.value.length,a.selectionEnd=a.value.length}),o()}else o(),l()}),$("#settings").keyup(function(t){"Enter"===t.key&&a()}),$("#btnSettings").click(function(){a()}),$("#btnSettingsHelp").click(function(){Util.Open(AssetPaths.HELP_WINDOW,"_blank",{})}),$("#btnSettingsBuilder").click(function(){s()}),onChange($("#txtChannel"),function(){setChannels(p,$(this).val().split(",")),mergeConfigObject({Channels:p.GetJoinedChannels()})}),$("#cbScroll").change(function(){var e=$(this).is(":checked");mergeConfigObject({Scroll:e}),$(".module .content").css("overflow-y",e?"scroll":"hidden")}),$("#cbTransparent").change(function(){var t=$(this).is(":checked");updateTransparency(t),e()}),$("#cbClips").change(function(){mergeConfigObject({ShowClips:$(this).is(":checked")}),e()}),$("#cbForce").change(function(){mergeConfigObject({NoForce:$(this).is(":checked")}),e()}),$("#selDebug").change(function(){var e=parseInt($(this).val());Util.Log("Changing debug level from "+Util.DebugLevel+" to "+e),Util.DebugLevel=e}),$("#btnReconnect").click(function(){p.Connect()}),$("#btnAdvanced, #btnAdvHide").click(function(){$("#advSettings").slideToggle()}),$("#cbAnimCheers").change(function(){mergeConfigObject({NoAnim:!$(this).is(":checked")}),e()}),onChange($("#txtBGStyle"),function(){$(".module").css("background-image",$(this).val())}),onChange($("#txtFont"),function(){var e=$(this).val();e&&("default"===e?Util.CSS.SetProperty("--body-font","var(--body-font-default)"):Util.CSS.SetProperty("--body-font",e))}),onChange($("#txtFontSize"),function(){var e=$(this).val();e&&("default"===e?Util.CSS.SetProperty("--body-font-size","var(--body-font-size-default)"):Util.CSS.SetProperty("--body-font-size",e))}),onChange($("#txtTag"),function(){mergeConfigObject({tag:$(this).val()})}),$(".module .header input.name").keyup(function(t){var e=$(this).parentsUntil(".column").last();"Enter"===t.key?d(e):"Escape"===t.key&&(e.find("input.name").val(e.find("label.name").html()),d(e))}),$(".module .header .clear-link").click(function(){$(this).parentsUntil(".column").find(".line-wrapper").remove()}),$(".module .settings input[type=\"text\"]").keyup(function(t){if("Enter"===t.key){var o=$(this).val();if(0<o.length){var e=$(this).closest("li"),n=e.attr("class").replace("textbox","").trim(),a=p.get("HTMLGen").checkbox(o,null,n,!0),r=e.find("label").html(),i=$("<li><label>"+a+r+" "+o+"</label></li>");e.before(i),$(this).val(""),updateModuleConfig()}}else"Escape"===t.key&&d($(this).parentsUntil(".column").last())}),$(document).keyup(function(t){if("ScrollLock"===t.key){/* ScrollLock: pause or resume auto-scroll */var e=$(".module .content"),n=e.attr("data-no-scroll");n?(e.removeAttr("data-no-scroll"),Util.Log("Auto-scroll enabled"),Content.addHelpText("Auto-scroll enabled")):(e.attr("data-no-scroll","1"),Util.Log("Auto-scroll disabled"),Content.addHelpText("Auto-scroll disabled"))}else if("Escape"===t.key){$("#settings").is(":visible")&&$("#settings").fadeOut();var a=!0,r=!1,i=void 0;try{for(var o,l,c=Object.values(getModules())[Symbol.iterator]();!(a=(o=c.next()).done);a=!0)l=o.value,$(l).find(".settings").is(":visible")&&d($(l))}catch(e){r=!0,i=e}finally{try{!a&&c.return&&c.return()}finally{if(r)throw i}}}else"F1"===t.key&&/* F1: open configuration help window */s()}),$(document).click(function(n){var e=$(n.target),a=!0,r=!1,o=void 0;/* Clicking on or off of the module settings button or box */try{for(var l,s=Object.values(getModules())[Symbol.iterator]();!(a=(l=s.next()).done);a=!0){var c=l.value,u=$(c),g=u.find(".menu"),h=u.find(".header"),f=u.find(".settings");Util.PointIsOn(n.clientX,n.clientY,g)?i(u):f.is(":visible")&&!Util.PointIsOn(n.clientX,n.clientY,f)&&!Util.PointIsOn(n.clientX,n.clientY,h)&&d(u)}/* Clicking off the main settings window */}catch(e){r=!0,o=e}finally{try{!a&&s.return&&s.return()}finally{if(r)throw o}}var m=$("#settings");m.is(":visible")&&!Util.PointIsOn(n.clientX,n.clientY,m)&&t();/* Clicking on the username context window */var b=$("#userContext");if(Util.PointIsOn(n.clientX,n.clientY,b)){var v=b.attr("data-channel"),S=b.attr("data-user"),y=b.attr("data-user-id");p.IsUIDSelf(y)||("cw-unmod"===e.attr("id")?(Util.Log("Unmodding "+S+" in "+v),p.SendMessage(v,"/unmod "+S)):"cw-unvip"===e.attr("id")?(Util.Log("Removing VIP for "+S+" in "+v),p.SendMessage(v,"/unvip "+S)):"cw-make-mod"===e.attr("id")?(Util.Log("Modding "+S+" in "+v),p.SendMessage(v,"/mod "+S)):"cw-make-vip"===e.attr("id")&&(Util.Log("VIPing "+S+" in "+v),p.SendMessage(v,"/vip "+S)))}else if("1"===e.attr("data-username")){/* Clicked on a username; show context window */var x=e.parent();b.is(":visible")?b.attr("data-user-id")===x.attr("data-user-id")?b.fadeOut():showUserContextWindow(p,b,x):showUserContextWindow(p,b,x)}else b.is(":visible")&&/* Clicked somewhere else: close context window */b.fadeOut();/* Clicking on a "Reconnect" link */"1"===e.attr("data-reconnect")&&(Content.addNoticeText("Reconnecting..."),p.Connect())}),p.bind("twitch-open",function(){$(".loading").remove(),$("#debug").hide(),Util.DebugLevel>=Util.LEVEL_DEBUG&&(p.IsAuthed()?Content.addInfoText("Connected (authenticated)"):Content.addInfoText("Connected (unauthenticated)")),0===getConfigValue("Channels").length&&Content.addInfoText("No channels configured; type //join <channel> to join one!")}),p.bind("twitch-close",function(t){var e=t.object.event.code,n=t.object.event.reason,a="(code "+e+" "+Util.WSStatus[e]+")";n&&(a="(code "+e+" "+Util.WSStatus[e]+": "+n+")"),getConfigValue("NoAutoReconnect")?Content.addErrorText("Connection closed "+a+" "+Strings.RECONNECT):(Content.addErrorText("Connection closed "+a+"; reconnecting in 5 seconds..."),!p.connecting&&window.setTimeout(function(){p.Connect()},5e3))}),p.bind("twitch-joined",function(t){var e=getConfigValue("Layout");e.Slim||Content.addInfoText("Joined "+Twitch.FormatChannel(t.channel))}),p.bind("twitch-parted",function(t){var e=getConfigValue("Layout");e.Slim||Content.addInfoText("Left "+Twitch.FormatChannel(t.channel))}),p.bind("twitch-notice",function(t){var e=Twitch.FormatChannel(t.channel),n=t.message;Content.addNoticeText(e+": "+n),"cmds_available"===t.noticeMsgId&&Content.addInfoText("Use //help to see Twitch Filtered Chat commands")}),p.bind("twitch-error",function(t){Util.Error(t);var e=t.user,n=t.values.command,a=t.message;Content.addErrorText("Error for "+e+": "+n+": "+a)}),p.bind("twitch-message",function(t){Util.DebugLevel>=Util.LEVEL_TRACE&&(t instanceof TwitchEvent?Content.addPreText(t.repr()):Content.addPreText(JSON.stringify(t)));/* Avoid flooding the DOM with stale chat messages */var e=getConfigValue("MaxMessages"),n=!0,a=!1,d=void 0;/* FIXME: Causes flickering for some reason */try{for(var r,i,o=$(".content")[Symbol.iterator]();!(n=(r=o.next()).done);n=!0)for(i=r.value;$(i).find(".line-wrapper").length>e;)$(i).find(".line-wrapper").first().remove()}catch(e){a=!0,d=e}finally{try{!n&&o.return&&o.return()}finally{if(a)throw d}}}),p.bind("twitch-streaminfo",function(t){var e=getConfigValue("Layout"),n=p.GetChannelInfo(t.channelString)||{};if(e&&!e.Slim)if(n.online)try{var a=n.stream.channel.url,d=n.stream.channel.display_name,r=n.stream.game,i=n.stream.viewers;Content.addNotice(Strings.StreamInfo(a,d,r,i)),n.stream.channel.status&&Content.addNoticeText(n.stream.channel.status)}catch(e){Util.ErrorOnly("Failed to obtain stream information:",n),Util.Error(e),Content.addNotice(Strings.StreamOnline(t.channelString))}else Content.addNotice(Strings.StreamOffline(t.channelString))}),p.bind("twitch-chat",function(t){if(t instanceof TwitchChatEvent){var e="string"==typeof t.message?t.message:"";if(t.flags&&t.flags.mod&&-1<e.indexOf(" ")){var n=e.split(" ");if("!tfc"===n[0]){if("reload"===n[1])location.reload();else if("force-reload"===n[1])location.reload(!0);else if("clear"===n[1])$(".content").children().remove();else if("nuke"===n[1]){if(n[2]&&1<n[2].length){var a=CSS.escape(n[2].toLowerCase());$("[data-user=\""+a+"\"]").parent().remove()}else $(".content").children().remove();}else if("ffdemo"===n[1]){var d=p.get("Fanfare");d._onChatEvent(p,{bits:1e3},!0),d._onSubEvent(p,{kind:TwitchSubEvent.SUB,plan:TwitchSubEvent.PLAN_TIER1},!0)}else if("ffcheerdemo"===n[1]){var r=p.get("Fanfare");r._onChatEvent(p,{bits:1e3},!0)}else if("ffsubdemo"===n[1]){var i=p.get("Fanfare");i._onSubEvent(p,{kind:TwitchSubEvent.SUB,plan:TwitchSubEvent.PLAN_TIER1},!0)}return}}}$(".module").each(function(){var e=p.get("HTMLGen");if(!shouldFilter($(this),t)){var n=$(this).find(".content"),a=$("<div class=\"line line-wrapper\"></div>"),d=e.gen(t),r=d.find(".message[data-clip]");if(0<r.length){var i=r.attr("data-clip");p.GetClip(i).then(function(t){p.GetGame(t.game_id).then(function(a){Content.addHTML(e.genClip(i,t,a),n)})})}a.append(d),Content.addHTML(a,n)}})}),p.bind("twitch-clearchat",function(t){if(t.flags["target-user-id"]){/* Moderator timed out a user */var e=CSS.escape(t.flags["room-id"]),n=CSS.escape(t.flags["target-user-id"]),a=$(".chat-line[data-channel-id=\""+e+"\"][data-user-id=\""+n+"\"]");a.parent().remove()}else/* Moderator cleared the chat */$("div.content").find(".line-wrapper").remove()}),p.bind("twitch-clearmsg",function(t){Util.StorageAppend(LOG_KEY,t),Util.Warn("Unhandled CLEARMSG:",t)}),p.bind("twitch-sub",function(t){Util.StorageAppend(LOG_KEY,t),Content.addHTML(p.get("HTMLGen").sub(t))}),p.bind("twitch-resub",function(t){/* Display the resub message, if one is present */if(Util.StorageAppend(LOG_KEY,t),Content.addHTML(p.get("HTMLGen").resub(t)),t.message){var e=p.get("HTMLGen").gen(t);e.addClass("message"),e.addClass("sub-message"),e.addClass("sub-user-message"),Content.addHTML(e)}}),p.bind("twitch-giftsub",function(t){Util.StorageAppend(LOG_KEY,t),Content.addHTML(p.get("HTMLGen").giftsub(t))}),p.bind("twitch-anongiftsub",function(t){Util.StorageAppend(LOG_KEY,t),Content.addHTML(p.get("HTMLGen").anongiftsub(t))}),p.bind("twitch-raid",function(t){Util.StorageAppend(LOG_KEY,t),Content.addHTML(p.get("HTMLGen").raid(t))}),p.bind("twitch-newuser",function(t){Util.StorageAppend(LOG_KEY,t);var e=p.get("HTMLGen"),n=e.newUser(t);n.find(".message").addClass("effect-rainbow").addClass("effect-disco"),Content.addHTML(n),Content.addHTML(e.gen(t))}),p.bind("twitch-rewardgift",function(t){Util.StorageAppend(LOG_KEY,t),Content.addHTML(p.get("HTMLGen").rewardGift(t))}),p.bind("twitch-mysterygift",function(t){Util.StorageAppend(LOG_KEY,t),Content.addHTML(p.get("HTMLGen").mysteryGift(t))}),p.bind("twitch-giftupgrade",function(t){Util.StorageAppend(LOG_KEY,t),Content.addHTML(p.get("HTMLGen").giftUpgrade(t))}),p.bind("twitch-primeupgrade",function(t){Util.StorageAppend(LOG_KEY,t),Content.addHTML(p.get("HTMLGen").giftUpgrade(t))}),p.bind("twitch-anongiftupgrade",function(t){Util.StorageAppend(LOG_KEY,t),Content.addHTML(p.get("HTMLGen").giftUpgrade(t))}),p.bind("twitch-otherusernotice",function(t){Util.StorageAppend(LOG_KEY,t),Util.Warn("Unknown USERNOTICE",t)}/* TODO: unraid, bitsbadgetier */),p.bind("twitch-reconnect",function(){/* Client will reconnect automatically */}),p.bind("twitch-join",function(){}),p.bind("twitch-part",function(){}),p.bind("twitch-hosttarget",function(){}),p.bind("twitch-userstate",function(){}),p.bind("twitch-roomstate",function(){}),p.bind("twitch-globaluserstate",function(){}),p.bind("twitch-usernotice",function(){}),p.bind("twitch-ack",function(){}),p.bind("twitch-ping",function(){}),p.bind("twitch-names",function(){}),p.bind("twitch-topic",function(){}),p.bind("twitch-privmsg",function(){}),p.bind("twitch-whisper",function(){}),p.bind("twitch-mode",function(){}),p.bind("twitch-other",function(){}),p.bindDefault(function(t){Util.Warn("Unbound event:",t),Util.StorageAppend(LOG_KEY,t)}),p.Connect()}/* globals AssetPaths Strings CSSCheerStyles GIT_URL CUR_URL LOG_KEY CFG_KEY *//* globals HTMLGenerator GetLayout ParseLayout FormatLayout Fanfare *//* vim: set ts=2 sts=2 sw=2 et: */