/* Twitch Filtered Chat Driver Script */'use strict';/* Module names (also used as directory names) */var MOD_TFC='twitch-filtered-chat',MOD_TWAPI='twitch-api',URI=''+window.location,IS_LOCAL='file:'===window.location.protocol,IS_HTTP='http:'===window.location.protocol,IS_HTTPS='https:'===window.location.protocol,IS_TESLA=!!navigator.userAgent.match(/\bTesla\b/),IS_GITIO=-1<window.location.hostname.indexOf('github.io'),USE_DIST=!!window.location.search.match(/\busedist\b/)||IS_TESLA,BASE_URI=URI.substr(0,URI.indexOf('twitch-filtered-chat')).replace(/\/$/,''),SELF_URI=URI.replace(/\/index.html(\?.*)?$/,''),ASSETS={};/* Obtain information based on window.location and navigator.userAgent *//* Asset storage object *//* Log things to the console, usable even if the console is disabled */function _console(a){if(console&&console[a]){for(var b,c=arguments.length,d=Array(1<c?c-1:0),e=1;e<c;e++)d[e-1]=arguments[e];return(b=console)[a].apply(b,d)}}function _console_error(){for(var a=arguments.length,b=Array(a),c=0;c<a;c++)b[c]=arguments[c];return _console.apply(void 0,['error'].concat(b))}function _console_warn(){for(var a=arguments.length,b=Array(a),c=0;c<a;c++)b[c]=arguments[c];return _console.apply(void 0,['warn'].concat(b))}function _console_log(){for(var a=arguments.length,b=Array(a),c=0;c<a;c++)b[c]=arguments[c];return _console.apply(void 0,['log'].concat(b))}function _console_info(){for(var a=arguments.length,b=Array(a),c=0;c<a;c++)b[c]=arguments[c];return _console.apply(void 0,['info'].concat(b))}function _console_debug(){for(var a=arguments.length,b=Array(a),c=0;c<a;c++)b[c]=arguments[c];return _console.apply(void 0,['debug'].concat(b))}/* Parse layout= query string value */function ParseLayout(a){/* exported ParseLayout */var b={Cols:null,Chat:!0,Slim:!1};if(-1<a.indexOf(':')){var c=a.substr(0,a.indexOf(':')),d=a.substr(a.indexOf(':')+1);'single'===c?b.Cols='single':'double'===c?b.Cols='double':(_console_warn('Unknown layout',c,'defaulting to double'),b.Cols='double'),'nochat'===d?b.Chat=!1:'slim'===d?(b.Slim=!0,b.Chat=!1):'chat'!==d&&_console_warn('Unknown layout option',d)}else'single'===a?b.Cols='single':'double'===a?b.Cols='double':'tesla'===a?(b.Cols='single',b.Chat=!1,b.Slim=!0,b.Tesla=!0):_console_error('Failed to parse layout',a);return b}/* Generate layout= query string value */function FormatLayout(a){/* exported FormatLayout */var b='',c='';return a.Tesla?'tesla':('single'===a.Cols?b='single':'double'===a.Cols&&(b='double'),c=a.Slim?'slim':a.Chat?'chat':'nochat',b+':'+c)}/* Obtain the final path to an asset */function GetAssetURL(a,b){var c=a,d='';b===MOD_TFC?USE_DIST?d=SELF_URI+'/dist':IS_GITIO?d=SELF_URI:d=SELF_URI:b===MOD_TWAPI?USE_DIST?d=BASE_URI+'/'+MOD_TWAPI+'/dist':IS_GITIO?d=BASE_URI+'/'+MOD_TWAPI:d=BASE_URI+'/'+MOD_TWAPI:a.startsWith('//')&&(IS_HTTPS?c='https:'+a:IS_HTTP?c='http:'+a:IS_LOCAL?c='http:'+a:(_console_info('Unknown protocol',window.location.protocol),c='http:'+a));var e=d?d+'/'+c:c;return _console_debug('GetAssetURL(',a,b,') ->',e),e}/* Add an asset to be loaded; returns a Promise */function AddAsset(a){var b=1<arguments.length&&arguments[1]!==void 0?arguments[1]:null,c=2<arguments.length&&arguments[2]!==void 0?arguments[2]:null,d=3<arguments.length&&arguments[3]!==void 0?arguments[3]:null,e=GetAssetURL(a,b);if(ASSETS[e])throw new Error('Asset '+e+' already added: '+JSON.stringify(ASSETS[e]));ASSETS[e]={};var f=ASSETS[e];return new Promise(function(g,h){_console_info('About to load asset',e),f.file=a,f.src=e,f.tree=b,f.loaded=!1,f.error=!1,f.script=document.createElement('script'),f.script.setAttribute('type','text/javascript'),f.script.setAttribute('src',f.src),f.script.onload=function(){_console_log(f.src+' loaded'),f.loaded=!0,c&&c(f),g(f)},f.script.onerror=function(a){_console_error('Failed loading',f,a),f.error=!0,d&&d(f,a),h(a)},document.head.appendChild(f.script)})}/* Load TWAPI */function loadTWAPI(){return Promise.all([AddAsset('utility.js',MOD_TWAPI,null,null),AddAsset('twitch-utility.js',MOD_TWAPI,null,null),AddAsset('client.js',MOD_TWAPI,null,null)])}/* Load TFC */function loadTFC(){/* Load config.js before everything else */return AddAsset('config.js',MOD_TFC,null,null).then(function(){return Promise.all([AddAsset('htmlgen.js',MOD_TFC,null,null),AddAsset('commands.js',MOD_TFC,null,null),AddAsset('filtered-chat.js',MOD_TFC,null,null),AddAsset('plugins/plugins.js',MOD_TFC,null,null)])})}/* Called by body.onload */function Main(){/* Add TWAPI assets, then TFC assets, and then call index_main */loadTWAPI().then(loadTFC).then(/* exported Main *//* Populate templates and load the client */function(){Util.LogOnly('Assets loaded; initializing page...'),$('#wrapper #wrapper-loading').remove();/* Obtain a layout to use */var a=Util.ParseQueryString().layout||'double:chat',b=ParseLayout(a),c=$('<textarea id="txtChat"></textarea>');/* Create the chat input elements */c.attr('placeholder','Send a message').attr('hist-index','-1');var d=$('<div id="chat"></div>').append(c),e=$('#column1'),f=$('#column2'),g=$('.column'),h=$('#module1'),i=$('#module2'),j=$('.module');/* Add the chat box */if(j.find('.clear-chat-icon').attr('width','1.1em').attr('height','1.1em'),j.find('.header .settings input[type="checkbox"]').attr('checked','checked'),j.find('.header label.name').val('Chat'),j.find('.header input.name').attr('value','Chat'),'single'===b.Cols?(e.removeClass('left').addClass('full'),h.removeClass('left').addClass('full'),e.show(),f.remove()):g.show(),b.Chat){var k=null;k='single'===b.Cols?h:i,k.removeClass('no-chat'),k.addClass('has-chat'),k.append(d)}/* Shrink the content for the Tesla */b.Tesla&&$('.module .content').css('height','calc(100% - 2em)'),b.Slim&&($('.header').hide(),$('.module').addClass('slim'),$('.content').addClass('slim'),$('#settings_button').hide()),InitChatCommands(),Util.LogOnly('Waiting for document to finish rendering...'),requestAnimationFrame(function(){/* Focus on the chat texarea */var a=document.getElementById('txtChat');a&&a.focus&&a.focus(),Util.LogOnly('Document rendered; setting up TFC...');try{client_main(b)}catch(a){if('ReferenceError'===a.name&&(a.message||'').match(/\bclient_main\b.*(?:not |un)defined\b/))throw alert('FATAL: filtered-chat.js failed to load; client_main is undefined'),a;_console_error(a);var c='client_main error: '+a.toString();throw a.stack&&(c+=';\nstack: '+a.stack.toString()),alert(c),a}})}).catch(function(a){var b='TWAPI/TFC Failure: ',c=a.target||a.srcElement||a.originalTarget;b+=c.attributes&&c.attributes.src&&c.attributes.src.value?'while loading '+c.attributes.src.value:c.outerHTML?'while loading '+c.outerHTML:'while loading '+c,_console_error(b,a),a.stack&&(b+=': stack: '+a.stack),alert(b)})}/* vim: set ts=2 sts=2 sw=2 et: */